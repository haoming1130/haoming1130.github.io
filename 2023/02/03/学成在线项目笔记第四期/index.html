<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>学成在线项目笔记第四期 | 小明学习博客</title><meta name="author" content="Haoming Lu"><meta name="copyright" content="Haoming Lu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="学成在线项目 day04-06 的项目内容">
<meta property="og:type" content="article">
<meta property="og:title" content="学成在线项目笔记第四期">
<meta property="og:url" content="http://haoming1130.github.io/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/index.html">
<meta property="og:site_name" content="小明学习博客">
<meta property="og:description" content="学成在线项目 day04-06 的项目内容">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg">
<meta property="article:published_time" content="2023-02-03T13:53:28.715Z">
<meta property="article:modified_time" content="2023-02-04T06:30:58.767Z">
<meta property="article:author" content="Haoming Lu">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://haoming1130.github.io/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '学成在线项目笔记第四期',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-02-04 14:30:58'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小明学习博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">学成在线项目笔记第四期</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-02-03T13:53:28.715Z" title="发表于 2023-02-03 21:53:28">2023-02-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-02-04T06:30:58.767Z" title="更新于 2023-02-04 14:30:58">2023-02-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>97分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="学成在线项目笔记第四期"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="媒资管理模块"><a href="#媒资管理模块" class="headerlink" title="媒资管理模块"></a><strong>媒资管理模块</strong></h1><h2 id="模块需求分析"><a href="#模块需求分析" class="headerlink" title="模块需求分析"></a><strong>模块需求分析</strong></h2><h3 id="模块介绍"><a href="#模块介绍" class="headerlink" title="模块介绍"></a><strong>模块介绍</strong></h3><p>媒资管理系统是每个在线教育平台所必须具备的，查阅百度百科对它的定义如下：</p>
<p>媒体资源管理(Media Asset Management，MAM)系统是建立在多媒体、网络、数据库和数字存储等先进技术基础上的一个对各种媒体及内容(如视&#x2F;音频资料、文本文件、图表等)进行数字化存储、管理以及应用的总体解决方案，包括数字媒体的采集、编目、管理、传输和编码转换等所有环节。其主要是满足<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%AA%92%E4%BD%93?fromModule=lemma_inlink">媒体</a>资源拥有者收集、保存、查找、编辑、发布各种信息的要求，为媒体资源的使用者提供访问内容的便捷方法，实现对媒体资源的高效管理，大幅度提高媒体资源的价值。</p>
<p>每个教学机构都可以在媒资系统管理自己的教学资源，包括：视频、教案等文件。</p>
<p>目前媒资管理的主要管理对象是视频、图片、文档等，包括：媒资文件的查询、文件上传、视频处理等。</p>
<p>媒资查询：教学机构查询自己所拥有的媒资信息。</p>
<p>文件上传：包括上传图片、上传文档、上传视频。</p>
<p>视频处理：视频上传成功，系统自动对视频进行编码处理。</p>
<p>文件删除：教学机构删除自己上传的媒资文件。</p>
<h2 id="搭建模块环境"><a href="#搭建模块环境" class="headerlink" title="搭建模块环境"></a><strong>搭建模块环境</strong></h2><h3 id="架构的问题分析"><a href="#架构的问题分析" class="headerlink" title="架构的问题分析"></a><strong>架构的问题分析</strong></h3><p>当前要开发的是媒资管理服务，目前为止共三个三微服务：内容管理、系统管理、媒资管理，后期还会添加更多的微服务，当前这种由前端直接请求微服务的方式存在弊端：<strong>如果在前端对每个请求地址都配置绝对路径，非常不利于系统维护</strong>，当系统上线后这里需要改成公网的域名，如果这种地址非常多则非常麻烦。</p>
<p>基于这个问题可以<strong>采用网关来解决</strong>，这样在前端的代码中只需要指定每个接口的相对路径，在前端代码的一个固定的地方在接口地址前统一加网关的地址，每个请求统一到网关，由网关将请求转发到具体的微服务。</p>
<blockquote>
<p>为什么所有的请求先到网关呢？</p>
</blockquote>
<p>有了网关就可以对请求进行路由，比如：可以根据请求路径路由、根据host地址路由等，当微服务有多个实例时可以通过负载均衡算法进行路由，另外，网关还可以实现权限控制、限流等功能。</p>
<p>项目采用Spring Cloud Gateway作为网关，网关在请求路由时需要知道每个微服务实例的地址，项目使用Nacos作用服务发现中心和配置中心，流程如下：</p>
<ol>
<li><p>微服务启动，将自己注册到Nacos，Nacos记录了各微服务实例的地址。</p>
</li>
<li><p>网关从Nacos读取服务列表，包括服务名称、服务地址等。</p>
</li>
<li><p>请求到达网关，网关将请求路由到具体的微服务。</p>
</li>
</ol>
<p>要使用网关首先搭建Nacos，Nacos有两个作用：</p>
<ul>
<li><p>服务发现中心。</p>
<ul>
<li>微服务将自身注册至Nacos，网关从Nacos获取微服务列表。</li>
</ul>
</li>
<li><p>配置中心。</p>
<ul>
<li>微服务众多，它们的配置信息也非常复杂，为了提供系统的可维护性，微服务的配置信息统一在Nacos配置。</li>
</ul>
</li>
</ul>
<h3 id="搭建Nacos"><a href="#搭建Nacos" class="headerlink" title="搭建Nacos"></a><strong>搭建Nacos</strong></h3><blockquote>
<p>这里我踩了很多坑，但是删删改改的很难总结，所以直接将最终版的写法展示出来</p>
</blockquote>
<h4 id="服务发现中心"><a href="#服务发现中心" class="headerlink" title="服务发现中心"></a><strong>服务发现中心</strong></h4><p>根据上节讲解的网关的架构图，要使用网关首先搭建Nacos。</p>
<p>首先搭建Nacos服务发现中心。</p>
<p>在搭建Nacos服务发现中心之前需要搞清楚两个概念：namespace和group</p>
<ul>
<li><p>namespace：用于区分环境、比如：开发环境、测试环境、生产环境。</p>
</li>
<li><p>group：用于区分项目，比如：xuecheng-plus项目、xuecheng2.0项目</p>
</li>
</ul>
<p>首先在nacos配置namespace：登录Centos，启动Naocs，使用 <code>sh /data/soft/restart.sh</code> 将自动启动Nacos。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">访问：http://192.168.101.65:8848/nacos/</span><br><span class="line"></span><br><span class="line">账号：nacos</span><br><span class="line">密码：nacos</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>首先完成各服务注册到Naocs（导文件，改配置）</strong>，将资料给的文件 nacos_config_export.zip 导入nacos</p>
</blockquote>
<p>下边将服务注册到nacos中。</p>
<ol>
<li>在xuecheng-parent中添加依赖管理</li>
</ol>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>在 <code>content-api</code> 工程、<code>content-service</code>工程、 <code>system-api</code> 工程以及<code>system-service</code> 工程中添加如下依赖</li>
</ol>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加Nacos 注册中心--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意是 discovery  和 config ！！！</p>
</blockquote>
<hr>
<ol start="3">
<li>在idea中配置nacos的地址</li>
</ol>
<ul>
<li><p>system-service 的配置文件</p>
<ol>
<li><p>改名：将 <code>application.yml</code> 改名为 <code>bootstrap.yml</code></p>
</li>
<li><p>在里面写入以下配置：</p>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>注意：profiles是和 cloud 同级的，不要顶格写！！！</p>
</blockquote>
<hr>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacosip:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project(自定义分组名称)</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<p>对应的是nacos的 system-service-dev.yaml 文件——<strong>主要存放的是service层连接数据库的信息</strong></p>
<p><img src="https://s2.loli.net/2023/02/03/YZbzEARJ14DiCWB.png" alt="image-20230203222912906"></p>
<hr>
<ul>
<li><p>system-api 的配置文件</p>
<ol>
<li><p>改名：将 <code>application.yml</code> 改名为 <code>bootstrap.yml</code></p>
</li>
<li><p>在里面写入以下配置：(注释掉的东西都写在了nacos中)</p>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>注意：profiles是和 cloud 同级的，不要顶格写！！！</p>
</blockquote>
<hr>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server:</span></span><br><span class="line"><span class="comment">#  servlet:</span></span><br><span class="line"><span class="comment">#    context-path: /system</span></span><br><span class="line"><span class="comment">#  port: 63110</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">system-api</span></span><br><span class="line"><span class="comment">#  mvc:</span></span><br><span class="line"><span class="comment">#    pathmatch:</span></span><br><span class="line"><span class="comment">#      matching-strategy: ANT_PATH_MATCHER</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacos</span> <span class="string">ip:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">system-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="comment">#logging:</span></span><br><span class="line"><span class="comment">#  config: classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的是nacos的 system-api-dev.yaml 文件看上图——主要存放的是 <strong>api层的端口号以及配置消息</strong></p>
<hr>
<ul>
<li><p>在 content-api 的配置文件：</p>
<ol>
<li><p>改名：将 <code>application.yml</code> 改名为 <code>bootstrap.yml</code></p>
</li>
<li><p>在里面写入以下配置：(注释掉的东西都写在了nacos中)</p>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>注意：profiles是和 cloud 同级的，不要顶格写！！！</p>
</blockquote>
<hr>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#server:</span></span><br><span class="line"><span class="comment">#  servlet:</span></span><br><span class="line"><span class="comment">#    context-path: /content</span></span><br><span class="line"><span class="comment">#  port: 63040</span></span><br><span class="line"><span class="comment">#微服务配置</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-api</span></span><br><span class="line"><span class="comment">#  mvc:</span></span><br><span class="line"><span class="comment">#    pathmatch:</span></span><br><span class="line"><span class="comment">#      matching-strategy: ANT_PATH_MATCHER</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">ip:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">content-service-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="comment">#logging:</span></span><br><span class="line"><span class="comment">#  config: classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的是nacos的 content-api-dev.yaml 文件看上图——主要存放的是 <strong>api层的端口号以及配置消息</strong></p>
<p><img src="https://s2.loli.net/2023/02/03/KdVzuNiq8CRMrcl.png" alt="image-20230203223739484"></p>
<hr>
<ul>
<li><p>content-service 的配置文件</p>
<ol>
<li><p>改名：将 <code>application.yml</code> 改名为 <code>bootstrap.yml</code></p>
</li>
<li><p>在里面写入以下配置：</p>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>注意：profiles是和 cloud 同级的，不要顶格写！！！</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">content-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">ip:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志文件配置路径</span></span><br><span class="line"><span class="comment">#logging:</span></span><br><span class="line"><span class="comment">#  config: classpath:log4j2-dev.xml</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对应的是nacos的 content-service-dev.yaml 文件看上图——<strong>主要存放的是service层连接数据库的信息</strong></p>
<hr>
<ol start="4">
<li>重启内容管理服务content、系统管理服务system。</li>
</ol>
<p>只要能在 “服务列表”看到启动情况：出现了 content-api 和 system-api，则说明nacos配置成功。</p>
<hr>
<p>启动content-api工程，查询控制台是否打印出了请求nacos的日志，如下:</p>
<hr>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[NacosRestTemplate.java:476] - HTTP method: POST, url:http://192.168.101.65:8848/nacos/v1/cs/configs/listener</span><br></pre></td></tr></table></figure>

<hr>
<p>并使用Httpclient测试课程查询接口是否可以正常查询。</p>
<h4 id="公用配置"><a href="#公用配置" class="headerlink" title="公用配置"></a>公用配置</h4><blockquote>
<p>如何在nacos中配置项目的公用配置呢？</p>
</blockquote>
<p>nacos提供了 shared-configs 可以引入公用配置。</p>
<p>对于swagger或者 knife4j 这类接口测试文档，可以将配置定义为一个公用配置，哪个项目需要用直接引入即可。(甚至别的项目也可以直接用)</p>
<p>单独在common分组下创建xuecheng的公用配置，进入nacos的开发环境，添加公用配置：</p>
<p><img src="https://s2.loli.net/2023/02/04/on7gxOjYFQ39ki8.png" alt="image-20230204003934050"></p>
<p>项目使用shared-configs可以引入公用配置。在接口工程的本地配置文件中引入公用配置，如上面的服务发现中心就已经添加了 shared-configs 引入了公用配置</p>
<p>配置完成后可以查看swagger&#x2F;knife4j接口文档是否可以正常访问，查看控制台log4j2日志输出是否正常。</p>
<h4 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a><strong>配置优先级</strong></h4><p>到目前为止已将所有微服务的配置统一在nacos进行配置，用到的配置文件有本地的配置文件bootstrap.yaml和nacos上的配置文件，引入配置文件的形式有：</p>
<ol>
<li><p>通过dataid方式引入</p>
</li>
<li><p>以扩展配置文件方式引入</p>
</li>
<li><p>以共享配置文件 方式引入</p>
</li>
</ol>
<blockquote>
<p>那么这几种配置文件方式的优先级是怎么样的呢</p>
</blockquote>
<ul>
<li>通过dataid方式引入优先级第一高</li>
<li>其次是扩展类配置文件（extension-configs）</li>
<li>再者是共享类配置文件（shared-configs）</li>
<li>最后本地配置文件优先级最低</li>
</ul>
<p>如果需要设置本地最优先，要在nacos配置文件中配置代码：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">            <span class="attr">override-none:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="搭建Gateway"><a href="#搭建Gateway" class="headerlink" title="搭建Gateway"></a><strong>搭建Gateway</strong></h3><p>本项目使用Spring Cloud Gateway作为网关，下边创建网关工程。</p>
<p>新建一个网关工程xuecheng-gateway，工程结构如下：</p>
<p><img src="https://s2.loli.net/2023/02/04/QX34cj9BVpneMm1.png" alt="image-20230204004555268"></p>
<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>配置pom文件：</p>
<hr>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../xuecheng-parent<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-gateway<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-gateway<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--网关--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--服务发现中心--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 Junit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<hr>
<h4 id="配置bootstrap-yaml配置文件"><a href="#配置bootstrap-yaml配置文件" class="headerlink" title="配置bootstrap.yaml配置文件"></a>配置bootstrap.yaml配置文件</h4><p>在gateway工程的 resource 中将 application.properties 改成 bootstrap.yml，在里面配置：</p>
<hr>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="string">nacoip:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">xcdev</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">xuecheng-online-project</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">refresh-enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">shared-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">data-id:</span> <span class="string">logging-$&#123;spring.profiles.active&#125;.yaml</span></span><br><span class="line">            <span class="attr">group:</span> <span class="string">common</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：profiles是和 cloud 同级的，不要顶格写！！！</p>
</blockquote>
<hr>
<p>在nacos上配置网关路由策略，详细配置导材料就行</p>
<hr>
<h4 id="接口测试"><a href="#接口测试" class="headerlink" title="接口测试"></a>接口测试</h4><p>启动网关工程，通过网关工程访问微服务进行测试。</p>
<p>在http-client-env.json中配置网关的地址，使用httpclient测试课程查询 接口，如下：</p>
<hr>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">### 课程查询列表</span><br><span class="line">POST <span class="punctuation">&#123;</span><span class="punctuation">&#123;</span>gateway_host<span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>/content/course/list?pageNo=<span class="number">2</span>&amp;pageSize=<span class="number">1</span></span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;courseName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>运行，对照数据库信息，观察是否可以正常访问接口 ，如下所示可以正常请求接口。</p>
<hr>
 <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">http<span class="punctuation">:</span><span class="comment">//localhost:63010/content/course/list?pageNo=2&amp;pageSize=1</span></span><br><span class="line"></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">transfer-encoding<span class="punctuation">:</span> chunked</span><br><span class="line">Content-Type<span class="punctuation">:</span> application/json</span><br><span class="line">Date<span class="punctuation">:</span> Sun<span class="punctuation">,</span> <span class="number">11</span> Sep <span class="number">2022</span> <span class="number">09</span><span class="punctuation">:</span><span class="number">54</span><span class="punctuation">:</span><span class="number">32</span> GMT</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring cloud实战&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="string">&quot;所有人&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mtName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;st&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1-3-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;200003&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;teachmode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;201001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;本课程主要从四个章节进行讲解： 1.微服务架构入门 2.spring cloud 基础入门 3.实战Spring Boot 4.注册中心eureka。&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pic&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.educba.com/academy/wp-content/uploads/2018/08/Spring-BOOT-Interview-questions.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-09-04 09:56:19&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2021-12-26 22:10:38&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;createPeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;changePeople&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;202002&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;203001&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubId&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;coursePubDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;counts&quot;</span><span class="punctuation">:</span> <span class="number">29</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pageSize&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="更改前端工程接口"><a href="#更改前端工程接口" class="headerlink" title="更改前端工程接口"></a>更改前端工程接口</h4><p>网关工程搭建完成即可将前端工程中的接口地址改为网关的地址</p>
<p><img src="https://s2.loli.net/2023/02/04/k94pCWvPQmUZEyO.png" alt="image-20230204005521609"></p>
<p>启动前端工程，测试之前开发内容管理模块的功能。</p>
<h3 id="搭建媒资工程"><a href="#搭建媒资工程" class="headerlink" title="搭建媒资工程"></a><strong>搭建媒资工程</strong></h3><p>至此网关、Nacos已经搭建完成，下边将媒资工程导入项目。(建议自己敲熟悉一下)</p>
<p><img src="https://s2.loli.net/2023/02/04/hSowxtJuFAYH75b.png" alt="image-20230204005814757"></p>
<ol>
<li><p>从课程资料中获取媒资工程 xuecheng-plus-media，拷贝到项目工程根目录。</p>
</li>
<li><p>右键pom.xml转为maven工程。</p>
</li>
<li><p>创建媒资数据库，并导入xcplus_media.sql</p>
</li>
<li><p>启动media-api工程测试运行</p>
</li>
</ol>
<h2 id="分布式文件系统"><a href="#分布式文件系统" class="headerlink" title="分布式文件系统"></a><strong>分布式文件系统</strong></h2><h3 id="MinIO介绍"><a href="#MinIO介绍" class="headerlink" title="MinIO介绍"></a><strong>MinIO介绍</strong></h3><p>本项目采用MinIO构建分布式文件系统，MinIO是一个非常轻量的服务,可以很简单的和其他应用的结合使用，它兼容亚马逊 S3云存储服务接口，非常适合于存储大容量非结构化的数据，例如图片、视频、日志文件、备份数据和容器&#x2F;虚拟机镜像等。</p>
<p>它一大特点就是轻量，使用简单，功能强大，支持各种平台，单个文件最大5TB，兼容Amazon S3接口，提供了 Java、Python、GO等多版本SDK支持。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://min.io/">https://min.io</a></p>
<p>中文：<a target="_blank" rel="noopener" href="https://www.minio.org.cn/%EF%BC%8Chttp://docs.minio.org.cn/docs/">https://www.minio.org.cn/，http://docs.minio.org.cn/docs/</a></p>
<p><strong>MinIO集群采用去中心化共享架构，每个结点是对等关系，通过Nginx可对MinIO进行负载均衡访问。</strong></p>
<blockquote>
<p>去中心化有什么好处？</p>
</blockquote>
<p>在大数据领域，通常的设计理念都是无中心和分布式。Minio分布式模式可以帮助你搭建一个高可用的对象存储服务，你可以使用这些存储设备，而不用考虑其真实物理位置。</p>
<p>它将分布在不同服务器上的多块硬盘组成一个对象存储服务。由于硬盘分布在不同的节点上，分布式Minio避免了单点故障。</p>
<p>Minio使用纠删码技术来保护数据，它是一种恢复丢失和损坏数据的数学算法，它将数据分块冗余的分散存储在各各节点的磁盘上，所有的可用磁盘组成一个集合，上图由8块硬盘组成一个集合，当上传一个文件时会通过纠删码算法计算对文件进行分块存储，除了将文件本身分成4个数据块，还会生成4个校验块，数据块和校验块会分散的存储在这8块硬盘上。</p>
<p>使用纠删码的好处是即便丢失一半数量（N&#x2F;2）的硬盘，仍然可以恢复数据。</p>
<h3 id="MinIO安装"><a href="#MinIO安装" class="headerlink" title="MinIO安装"></a>MinIO安装</h3><p>直接cmd运行MinIO.exe就能跑起来，最好看着视频弄，挂在虚拟机或者服务器上要去官网下对应的二进制文件</p>
<p>安装参考文档：<a target="_blank" rel="noopener" href="https://blog.csdn.net/cucgyfjklx/article/details/122733947">安装参考</a></p>
<p>重定向问题参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43460193/article/details/120844862">nohup出问题了</a></p>
<p>MinIO 对象存储参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_60257072/article/details/128172685">MinIO 对象存储</a></p>
<h3 id="上传文件-图片-测试"><a href="#上传文件-图片-测试" class="headerlink" title="上传文件(图片)测试"></a>上传文件(图片)测试</h3><p>MinIO提供多个语言版本SDK的支持，下边找到java版本的文档：</p>
<p>地址：<a target="_blank" rel="noopener" href="https://docs.min.io/docs/java-client-quickstart-guide.html">https://docs.min.io/docs/java-client-quickstart-guide.html</a></p>
<p>最低需求Java 1.8或更高版本:</p>
<p>在media-service工程添加此依赖，依赖如下：(我直接附全部pom配置了)</p>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-media<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-media-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>xuecheng-media-service<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>xuecheng-media-service<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuecheng<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xuecheng-media-model<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- MySQL 驱动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- mybatis plus的依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 Junit --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 排除 Spring Boot 依赖的日志包冲突 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot 集成 log4j2 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--添加 minio 分布式文件系统--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.minio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>minio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--添加 xxl_job 调度中心--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="MinIO参数说明"><a href="#MinIO参数说明" class="headerlink" title="MinIO参数说明"></a>MinIO参数说明</h3><p>需要三个参数才能连接到minio服务。</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Endpoint</td>
<td align="center">对象存储服务的URL</td>
</tr>
<tr>
<td align="center">Access Key</td>
<td align="center">Access key就像用户ID，可以唯一标识你的账户。</td>
</tr>
<tr>
<td align="center">Secret Key</td>
<td align="center">Secret key是你账户的密码。</td>
</tr>
</tbody></table>
<hr>
<h3 id="MinIO功能测试"><a href="#MinIO功能测试" class="headerlink" title="MinIO功能测试"></a>MinIO功能测试</h3><p>在media-service中添加测试用例，测试，示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.bind.SchemaOutputResolver;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FilterInputStream;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MediaServiceApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">            MinioClient.builder()</span><br><span class="line">                    .endpoint(<span class="string">&quot;http://MinIOIP:9000&quot;</span>)	<span class="comment">//建议本机启动好看效果</span></span><br><span class="line">                    .credentials(<span class="string">&quot;minioadmin&quot;</span>, <span class="string">&quot;minioadmin&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上传</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">UploadObjectArgs</span> <span class="variable">uploadObjectArgs</span> <span class="operator">=</span> UploadObjectArgs.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)	<span class="comment">//在minIo页面创建的 bucket名称</span></span><br><span class="line">                    .object(<span class="string">&quot;rurisa.jpg&quot;</span>)	<span class="comment">//要上传的文件名称</span></span><br><span class="line">                    .filename(<span class="string">&quot;文件上传的本地路径\\rurisa.jpg&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            minioClient.uploadObject(uploadObjectArgs);</span><br><span class="line">            System.out.println(<span class="string">&quot;上传成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">RemoveObjectArgs</span> <span class="variable">removeObjectArgs</span> <span class="operator">=</span> RemoveObjectArgs.builder()</span><br><span class="line">                    .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                    .object(<span class="string">&quot;rurisa.jpg&quot;</span>)</span><br><span class="line">                    .build();</span><br><span class="line">            minioClient.removeObject(removeObjectArgs);</span><br><span class="line">            System.out.println(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;删除失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询/下载对象</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GetObjectArgs</span> <span class="variable">getObjectArgs</span> <span class="operator">=</span> GetObjectArgs.builder()</span><br><span class="line">                .bucket(<span class="string">&quot;testbucket&quot;</span>)</span><br><span class="line">                .object(<span class="string">&quot;rurisa.jpg&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                <span class="type">FilterInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> minioClient.getObject(getObjectArgs);</span><br><span class="line">                <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;文件下载的存放路径\\pretty.jpg&quot;</span>));</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                IOUtils.copy(inputStream, fileOutputStream);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;查询失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>执行方法，在MinIO页面查看效果，以及在文件下载指定文件夹中查看下载效果</p>
<hr>
<h2 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a><strong>上传图片</strong></h2><h3 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h3><h4 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h4><p>课程图片是宣传课程非常重要的信息，在新增课程界面上传课程图片，也可以修改课程图片。</p>
<p><img src="https://s2.loli.net/2023/02/04/2X3N7krZcwBpsgE.png" alt="image-20230204012551573"></p>
<p>课程图片上传至分布式文件系统，在课程信息中保存课程图片路径，如下流程：</p>
<p><img src="https://s2.loli.net/2023/02/04/3rSqsGbXedIDJag.png" alt="image-20230204012612381"></p>
<ol>
<li><p>前端进入上传图片界面</p>
</li>
<li><p>上传图片，请求媒资管理服务。</p>
</li>
<li><p>媒资管理服务将图片文件存储在MinIO。</p>
</li>
<li><p>媒资管理记录文件信息到数据库。</p>
</li>
<li><p>保存课程信息，在内容管理数据库保存图片地址。</p>
</li>
</ol>
<p>媒资管理服务由接口层和业务层共同完成，具体分工如下：</p>
<p>用户上传图片请求至媒资管理的接口层，接口层解析文件信息通过业务层将文件保存至minio及数据库。如下图：</p>
<p><img src="https://s2.loli.net/2023/02/04/qMvHe5DhXBtNOJE.png" alt="image-20230204012735647"></p>
<h4 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a><strong>数据模型</strong></h4><p>涉及到的数据表有：课程信息表courseBase中的图片字段、媒资数据库media的文件表mediaFiles</p>
<h4 id="接口定义"><a href="#接口定义" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h4><p>根据需求分析，下边进行接口定义，此接口定义为一个通用的上传文件接口，可以上传图片或其它文件。</p>
<p>请求参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">请求地址：/media/upload/coursefile</span><br><span class="line"></span><br><span class="line">**Content-Type<span class="punctuation">:</span>** multipart/form-data;boundary=\.....</span><br><span class="line"></span><br><span class="line">FormData<span class="punctuation">:</span> **filedata=??**</span><br></pre></td></tr></table></figure>



<p>响应参数：文件信息</p>
<hr>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyId&quot;</span><span class="punctuation">:</span> <span class="number">1232141425</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;companyName&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;filename&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;001001&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bucket&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;a16da7a132559daf9e1193166b3e7f52&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/testbucket/2022/09/12/a16da7a132559daf9e1193166b3e7f52.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timelength&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;createDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-09-12T21:57:18&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;changeDate&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditStatus&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auditMind&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fileSize&quot;</span><span class="punctuation">:</span> <span class="number">248329</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a><strong>准备环境</strong></h3><h4 id="配置bucket"><a href="#配置bucket" class="headerlink" title="配置bucket"></a>配置bucket</h4><p>首先在minio配置bucket，bucket名称为：mediafiles，并设置bucket的权限为公开。</p>
<p>在nacos配置中minio的相关信息，进入media-service-dev.yaml，配置信息如下：</p>
<hr>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">YAML</span></span><br><span class="line"><span class="attr">minio:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">http://minioIp:9000</span></span><br><span class="line">  <span class="attr">accessKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">secretKey:</span> <span class="string">minioadmin</span></span><br><span class="line">  <span class="attr">bucket:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">mediafiles</span></span><br><span class="line">    <span class="attr">videofiles:</span> <span class="string">video</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="编写minio配置类"><a href="#编写minio配置类" class="headerlink" title="编写minio配置类"></a>编写minio配置类</h4><p>在media-service工程中创建config文件夹，编写minio的配置类：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Minio 配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/29 17:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MinioConfig</span> &#123;</span><br><span class="line">    <span class="comment">//读取参数</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.accessKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.secretKey&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MinioClient <span class="title function_">minioClient</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">MinioClient</span> <span class="variable">minioClient</span> <span class="operator">=</span></span><br><span class="line">                MinioClient.builder()</span><br><span class="line">                        .endpoint(endpoint)</span><br><span class="line">                        .credentials(accessKey, secretKey)</span><br><span class="line">                        .build();</span><br><span class="line">        <span class="keyword">return</span> minioClient;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="model-生成DTO"><a href="#model-生成DTO" class="headerlink" title="model-生成DTO"></a>model-生成DTO</h3><p>在media-model 中创建DTO类</p>
<h4 id="定义媒资文件查询请求模型类"><a href="#定义媒资文件查询请求模型类" class="headerlink" title="定义媒资文件查询请求模型类"></a>定义媒资文件查询请求模型类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaModel.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件查询请求模型类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/29 17:28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QueryMediaParamsDto</span> &#123;</span><br><span class="line">    <span class="comment">//媒资文件名称</span></span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//媒资类型</span></span><br><span class="line">    <span class="keyword">private</span> String fileType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//审核状态</span></span><br><span class="line">    <span class="keyword">private</span> String auditStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="定义上传响应模型类"><a href="#定义上传响应模型类" class="headerlink" title="定义上传响应模型类"></a>定义上传响应模型类</h4><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaModel.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件响应参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/29 17:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileResultDto</span> <span class="keyword">extends</span> <span class="title class_">MediaFiles</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="定义请求参数类"><a href="#定义请求参数类" class="headerlink" title="定义请求参数类"></a>定义请求参数类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaModel.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 上传普通文件请求参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/29 17:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadFileParamsDto</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String filename;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件content-type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String contentType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件类型（文档，音频，视频）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String fileType;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long fileSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 标签</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="service-接口开发"><a href="#service-接口开发" class="headerlink" title="service-接口开发"></a>service-接口开发</h3><h4 id="定义service方法"><a href="#定义service方法" class="headerlink" title="定义service方法"></a>定义service方法</h4><p>在mediafilesservice中定义方法：</p>
<blockquote>
<p>注意：service和impl中涵盖了day04-06三天的接口方法，可以做到哪了再往上写</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span>  媒资文件管理业务类</span></span><br><span class="line"><span class="comment">* <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaFilesService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MediaFiles&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 媒资文件查询方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queryMediaParamsDto 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.mediaModel.po.MediaFiles&gt;&lt;/&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:39</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">queryMediaFiles</span><span class="params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 上传文件的通用接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> folder 桶下边的子目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.dto.UploadFileResultDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:42</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, <span class="type">byte</span>[] bytes,String folder,String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件信息添加到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 上传文件的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 21:13</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDB</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket_files,String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将媒资文件添加到MinIO中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 字节数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentType 内容类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:33</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(<span class="type">byte</span>[] bytes, String bucket_files, String objectName, String contentType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加媒资文件到MinIO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:32</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String filePath, String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据桶和文件路径从minio下载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.io.File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:31</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(File file, String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 检查文件是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件的Md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:14</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 检查分块是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunkIndex 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 上传分块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunk 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 文件字节</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,<span class="type">byte</span>[] bytes)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 合并分块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:17</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId,String fileMd5,<span class="type">int</span> chunkTotal,UploadFileParamsDto uploadFileParamsDto)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据id查询文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 文件id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 16:27</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="实现service方法impl"><a href="#实现service方法impl" class="headerlink" title="实现service方法impl"></a>实现service方法impl</h4><blockquote>
<p>注意：service和impl中涵盖了三天的接口方法，可以做到哪了再往上写</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaFilesService;</span><br><span class="line"><span class="keyword">import</span> io.minio.GetObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.PutObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.compress.utils.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件管理业务实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFilesServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;MediaFilesMapper, MediaFiles&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">MediaFilesService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MinioClient minioClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesService currentProxy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket_files;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket_videoFiles;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">queryMediaFiles</span><span class="params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span> &#123;</span><br><span class="line">        <span class="comment">//构建查询条件对象</span></span><br><span class="line">        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(StringUtils.isNotBlank(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());</span><br><span class="line"></span><br><span class="line">        queryWrapper.like(StringUtils.isNotBlank(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());</span><br><span class="line">        <span class="comment">//分页对象</span></span><br><span class="line">        Page&lt;MediaFiles&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);</span><br><span class="line">        <span class="comment">// 获取数据列表</span></span><br><span class="line">        List&lt;MediaFiles&gt; list = pageResult.getRecords();</span><br><span class="line">        <span class="comment">// 获取数据总数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">        <span class="comment">// 构建结果集</span></span><br><span class="line">        PageResult&lt;MediaFiles&gt; mediaListResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        <span class="keyword">return</span> mediaListResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, <span class="type">byte</span>[] bytes, String folder, String objectName)</span> &#123;</span><br><span class="line">        <span class="comment">//生成文件id，文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> DigestUtils.md5Hex(bytes);</span><br><span class="line">        <span class="comment">//得到文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(folder)) &#123;</span><br><span class="line">            <span class="comment">//自动生成目录的路径 按年月日生成，</span></span><br><span class="line">            folder = getFileFolder(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (folder.indexOf(<span class="string">&quot;/&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            folder = folder + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(objectName)) &#123;</span><br><span class="line">            <span class="comment">//如果objectName为空，使用文件的md5值为objectName</span></span><br><span class="line">            objectName = fileMd5 + filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        objectName = folder + objectName;</span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//上传至文件系统</span></span><br><span class="line">            addMediaFilesToMinIO(bytes, bucket_files, objectName, uploadFileParamsDto.getContentType());</span><br><span class="line">            <span class="comment">//写入文件表</span></span><br><span class="line">            mediaFiles = currentProxy.addMediaFilesToDB(companyId, fileId, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//准备返回数据</span></span><br><span class="line">            <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();</span><br><span class="line">            BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);</span><br><span class="line">            <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.debug(<span class="string">&quot;上传文件失败：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId           机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5             文件md5值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 上传文件的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files        桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName          对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件信息添加到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 20:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDB</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket_files, String objectName)</span> &#123;</span><br><span class="line">        <span class="comment">//保存到数据库</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//封装数据</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setBucket(bucket_files);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket_files + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002004&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取出文件扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> objectName.substring(objectName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//如果是avi则加入视频处理表</span></span><br><span class="line">        <span class="keyword">if</span> (extension.equalsIgnoreCase(<span class="string">&quot;.avi&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">            BeanUtils.copyProperties(mediaFiles, mediaProcess);</span><br><span class="line">            mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">            <span class="comment">//更新url为空</span></span><br><span class="line">            mediaFiles.setUrl(<span class="literal">null</span>);</span><br><span class="line">            mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mediaFiles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes        文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName   对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentType  内容类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件写入minIO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 20:58</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(<span class="type">byte</span>[] bytes, String bucket_files, String objectName, String contentType)</span> &#123;</span><br><span class="line">        <span class="comment">//转为流</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()</span><br><span class="line">                    .bucket(bucket_files)</span><br><span class="line">                    .object(objectName)</span><br><span class="line">                    <span class="comment">//InputStream stream, long objectSize 对象大小, long partSize 分片大小(-1表示5M,最大不要超过5T，最多10000)</span></span><br><span class="line">                    .stream(byteArrayInputStream, byteArrayInputStream.available(), -<span class="number">1</span>)</span><br><span class="line">                    .contentType(contentType)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">//上传到minio</span></span><br><span class="line">            minioClient.putObject(putObjectArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传文件到文件系统出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">        <span class="comment">//查询文件信息</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">        <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//桶</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">            <span class="comment">//存储目录</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">            <span class="comment">//文件流</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stream = minioClient.getObject(</span><br><span class="line">                        GetObjectArgs.builder()</span><br><span class="line">                                .bucket(bucket)</span><br><span class="line">                                .object(filePath)</span><br><span class="line">                                .build());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//文件已存在</span></span><br><span class="line">                    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件不存在</span></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line">        <span class="comment">//得到分块文件目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        <span class="comment">//得到分块文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//文件流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket_videoFiles)</span><br><span class="line">                            .object(chunkFilePath)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//分块已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分块未存在</span></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件的目录</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        <span class="comment">//得到分块文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunk;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//将文件存储至minIO</span></span><br><span class="line">            addMediaFilesToMinIO(bytes, bucket_videoFiles, chunkFilePath, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传过程出错请重试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查所有分块是否上传完毕</span></span><br><span class="line">    <span class="keyword">private</span> File[] checkChunkStatus(String fileMd5, <span class="type">int</span> chunkTotal) &#123;</span><br><span class="line">        <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        File[] files = <span class="keyword">new</span> <span class="title class_">File</span>[chunkTotal];</span><br><span class="line">        <span class="comment">//检查分块文件是否上传完毕</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkTotal; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + i;</span><br><span class="line">            <span class="comment">//下载文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">chunkFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                chunkFile = File.createTempFile(<span class="string">&quot;chunk&quot;</span> + i, <span class="literal">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;下载分块时创建临时文件出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            downloadFileFromMinIO(chunkFile, bucket_videoFiles, chunkFilePath);</span><br><span class="line">            files[i] = chunkFile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> files;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据桶和文件路径从minio下载文件</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(File file, String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(objectName)</span><br><span class="line">                            .build());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileOutputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">                IOUtils.copy(fileInputStream, fileOutputStream);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;下载文件&quot;</span> + objectName + <span class="string">&quot;出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;文件不存在&quot;</span> + objectName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileInputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fileOutputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileOutputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">        <span class="comment">//下载所有分块文件</span></span><br><span class="line">        File[] chunkFiles = checkChunkStatus(fileMd5, chunkTotal);</span><br><span class="line">        <span class="comment">//扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//创建临时文件作为合并文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mergeFile = File.createTempFile(fileMd5, extName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;合并文件过程中创建临时文件出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开始合并</span></span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File chunkFile : chunkFiles) &#123;</span><br><span class="line">                    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">chunkFileStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(chunkFile);) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((len = chunkFileStream.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="comment">//向合并后的文件写</span></span><br><span class="line">                            raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件过程中出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;合并文件完成&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            uploadFileParamsDto.setFileSize(mergeFile.length());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">mergeFileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);) &#123;</span><br><span class="line">                <span class="comment">//对文件进行校验，通过比较md5值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">newFileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(mergeFileInputStream);</span><br><span class="line">                <span class="keyword">if</span> (!fileMd5.equalsIgnoreCase(newFileMd5)) &#123;</span><br><span class="line">                    <span class="comment">//校验失败</span></span><br><span class="line">                    XueChengException.cast(<span class="string">&quot;合并文件校验失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;合并文件校验通过&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">//校验失败</span></span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件校验异常&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将临时文件上传至minio</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">mergeFilePath</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//上传文件到minIO</span></span><br><span class="line">                addMediaFilesToMinIO(mergeFile.getAbsolutePath(), bucket_videoFiles, mergeFilePath);</span><br><span class="line">                log.debug(<span class="string">&quot;合并文件上传MinIO完成&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件时上传文件出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//入数据库</span></span><br><span class="line">            <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> addMediaFilesToDB(companyId, fileMd5, uploadFileParamsDto, bucket_videoFiles, mergeFilePath);</span><br><span class="line">            <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;媒资文件入库出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除临时文件</span></span><br><span class="line">            <span class="keyword">for</span> (File file : chunkFiles) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    file.delete();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mergeFile.delete();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePathByMd5</span><span class="params">(String fileMd5, String fileExt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + fileMd5 + fileExt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将文件上传到minIO，传入文件绝对路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String filePath, String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            minioClient.uploadObject(</span><br><span class="line">                    UploadObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(objectName)</span><br><span class="line">                            .filename(filePath)</span><br><span class="line">                            .build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传文件到文件系统出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> date 日期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据日期拼接目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:48</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileFolder</span><span class="params">(Date date, <span class="type">boolean</span> year, <span class="type">boolean</span> month, <span class="type">boolean</span> day)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="comment">//获取当前日期字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dateString</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//取出年、月、日</span></span><br><span class="line">        String[] dateStringArray = dateString.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">folderString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">if</span> (year) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">0</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">1</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (day) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">2</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> folderString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="api-接口定义"><a href="#api-接口定义" class="headerlink" title="api-接口定义"></a>api-接口定义</h3><p>在 media-api 中创建 mediaFilesController，实现以下接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaApi.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaFilesService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件管理接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/1/29 17:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFilesController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesService mediaFilesService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/files&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">list</span><span class="params">(PageParams pageParams, <span class="meta">@RequestBody</span> QueryMediaParamsDto queryMediaParamsDto)</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesService.queryMediaFiles(companyId, pageParams, queryMediaParamsDto);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/upload/coursefile&quot;, consumes = &#123;MediaType.MULTIPART_FORM_DATA_VALUE&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">upload</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestPart(&quot;filedata&quot;)</span> MultipartFile filedata,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;folder&quot;, required = false)</span> String folder,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(value = &quot;objectName&quot;, required = false)</span> String objectName</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line">        <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> filedata.getContentType();</span><br><span class="line">        uploadFileParamsDto.setContentType(contentType);</span><br><span class="line">        uploadFileParamsDto.setFileSize(filedata.getSize());<span class="comment">//文件大小</span></span><br><span class="line">        <span class="keyword">if</span> (contentType.indexOf(<span class="string">&quot;image&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//是个图片</span></span><br><span class="line">            uploadFileParamsDto.setFileType(<span class="string">&quot;001001&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            uploadFileParamsDto.setFileType(<span class="string">&quot;001003&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        uploadFileParamsDto.setFilename(filedata.getOriginalFilename());<span class="comment">//文件名称</span></span><br><span class="line">        <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            uploadFileResultDto = mediaFilesService.uploadFile(companyId, uploadFileParamsDto, filedata.getBytes(), folder, objectName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传文件过程中出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口测试-1"><a href="#接口测试-1" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h3><h4 id="httpClient测试"><a href="#httpClient测试" class="headerlink" title="httpClient测试"></a>httpClient测试</h4><hr>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">### 上传文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/coursefile</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;filedata&quot;; filename=&quot;文件名称&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; 文件路径/rurisa.jpg</span><br></pre></td></tr></table></figure>

<h4 id="前后端联调测试"><a href="#前后端联调测试" class="headerlink" title="前后端联调测试"></a>前后端联调测试</h4><p>在新增课程、编辑课程界面上传图，保存课程信息后再次进入编辑课程界面，查看是否可以正常保存课程图片信息。</p>
<p>上图图片完成后，进入媒资管理，查看文件列表中是否有刚刚上传的图片信息。</p>
<h3 id="bug修复"><a href="#bug修复" class="headerlink" title="bug修复"></a><strong>bug修复</strong></h3><p>上文代码已经修复，主要是对 queryMediaFiles 查询media 信息的方法添加 querywrapper自定义查询，可自行上翻查阅</p>
<h2 id="上传视频"><a href="#上传视频" class="headerlink" title="上传视频"></a><strong>上传视频</strong></h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h3><ol>
<li><p>教学机构人员进入媒资管理列表查询自己上传的媒资文件。</p>
</li>
<li><p>教育机构用户在&quot;媒资管理&quot;页面中点击 &quot;上传视频&quot; 按钮。</p>
</li>
<li><p>选择要上传的文件，自动执行文件上传。</p>
</li>
<li><p>视频上传成功会自动处理，处理完成可以预览视频。</p>
</li>
</ol>
<h3 id="断点续传流程"><a href="#断点续传流程" class="headerlink" title="断点续传流程"></a><strong>断点续传流程</strong></h3><h4 id="什么是断点续传"><a href="#什么是断点续传" class="headerlink" title="什么是断点续传"></a><strong>什么是断点续传</strong></h4><p>通常视频文件都比较大，所以对于媒资系统上传文件的需求要满足大文件的上传要求。http协议本身对上传文件大小没有限制，但是客户的网络环境质量、电脑硬件环境等参差不齐，如果一个大文件快上传完了网断了没有上传完成，需要客户重新上传，用户体验非常差，所以对于大文件上传的要求最基本的是断点续传。</p>
<p>引用百度百科：断点续传指的是在下载或上传时，将下载或上传任务（一个文件或一个压缩包）人为的划分为几个部分，每一个部分采用一个线程进行上传或下载，如果碰到网络故障，可以从已经上传或下载的部分开始继续上传下载未完成的部分，而没有必要从头开始上传下载，断点续传可以提高节省操作时间，提高用户体验性。</p>
<p>流程如下：</p>
<ol>
<li><p>前端上传前先把文件分成块</p>
</li>
<li><p>一块一块的上传，上传中断后重新上传，已上传的分块则不用再上传</p>
</li>
<li><p>各分块上传完成最后在服务端合并文件</p>
</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/WulpGXi5tKhj4YZ.png" alt="image-20230204131124400"></p>
<h4 id="分块原理"><a href="#分块原理" class="headerlink" title="分块原理"></a><strong>分块原理</strong></h4><p>为了更好的理解文件分块上传的原理，下边用java代码测试文件的分块与合并。文件分块的流程如下：</p>
<ol>
<li><p>获取源文件长度</p>
</li>
<li><p>根据设定的分块文件的大小计算出块数</p>
</li>
<li><p>从源文件读数据依次向每一个块文件写数据。</p>
</li>
</ol>
<hr>
<h4 id="合并原理"><a href="#合并原理" class="headerlink" title="合并原理"></a>合并原理</h4><p>文件合并流程：</p>
<ol>
<li><p>找到要合并的文件并按文件合并的先后进行排序。</p>
</li>
<li><p>创建合并文件</p>
</li>
<li><p>依次从合并的文件中读取数据向合并文件写入数</p>
</li>
</ol>
<hr>
<h4 id="上传视频流程"><a href="#上传视频流程" class="headerlink" title="上传视频流程"></a><strong>上传视频流程</strong></h4><p>下图是上传视频的整体流程：</p>
<p><img src="https://s2.loli.net/2023/02/04/6DRPqO3dvaIy4Jn.png" alt="image-20230204131446844"></p>
<ol>
<li>前端上传文件前请求媒资接口层检查文件是否存在，如果已经存在则不再上传。</li>
<li>如果文件在系统不存在前端开始上传，首先对视频文件进行分块</li>
<li>前端分块进行上传，上传前首先检查分块是否上传，如已上传则不再上传，如果未上传则开始上传分块。</li>
<li>前端请求媒资管理接口层请求上传分块。</li>
<li>接口层请求服务层上传分块。</li>
<li>服务端将分块信息上传到MinIO。</li>
<li>前端将分块上传完毕请求接口层合并分块。</li>
<li>接口层请求服务层合并分块。</li>
<li>服务层根据文件信息找到MinIO中的分块文件，下载到本地临时目录，将所有分块下载完毕后开始合并。</li>
<li>合并完成将合并后的文件上传到MinIO。</li>
</ol>
<h3 id="准备环境-1"><a href="#准备环境-1" class="headerlink" title="准备环境"></a>准备环境</h3><p>在 base 工程的 model 中创建 RestResponse 通用结果模型类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.base.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 通用结果类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/2 14:08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestResponse</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应编码,0为正常,-1错误</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应提示信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 响应内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="number">0</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RestResponse</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 错误信息的封装</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">validfail</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setCode(-<span class="number">1</span>);</span><br><span class="line">        response.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加正常响应数据（包含响应内容）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RestResponse Rest服务封装相应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">(T result)</span> &#123;</span><br><span class="line">        RestResponse&lt;T&gt; response = <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">        response.setResult(result);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加正常响应数据（不包含响应内容）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RestResponse Rest服务封装相应数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; RestResponse&lt;T&gt; <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestResponse</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">isSuccessful</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.code == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="model-生成DTO-1"><a href="#model-生成DTO-1" class="headerlink" title="model-生成DTO"></a>model-生成DTO</h3><p>无新添加的配置，略</p>
<h3 id="service-接口开发-1"><a href="#service-接口开发-1" class="headerlink" title="service-接口开发"></a>service-接口开发</h3><p>上传视频主要实现四个接口：检查文件是否存在、检查分块是否存在、上传分块 以及 合并分块</p>
<h4 id="定义service方法-1"><a href="#定义service方法-1" class="headerlink" title="定义service方法"></a>定义service方法</h4><p>在mediafilesservice中定义接口方法：</p>
<blockquote>
<p>如果是导入我上传图片时的service，应该已经写好了，这里也是偷懒直接将整个service复制过来</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span>  媒资文件管理业务类</span></span><br><span class="line"><span class="comment">* <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaFilesService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MediaFiles&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 媒资文件查询方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageParams 分页参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queryMediaParamsDto 查询条件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.PageResult&lt;com.xuecheng.mediaModel.po.MediaFiles&gt;&lt;/&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:39</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">queryMediaFiles</span><span class="params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 上传文件的通用接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> folder 桶下边的子目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.dto.UploadFileResultDto</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:42</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, <span class="type">byte</span>[] bytes,String folder,String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件信息添加到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 上传文件的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 21:13</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDB</span><span class="params">(Long companyId,String fileMd5,UploadFileParamsDto uploadFileParamsDto,String bucket_files,String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将媒资文件添加到MinIO中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 字节数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentType 内容类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:33</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(<span class="type">byte</span>[] bytes, String bucket_files, String objectName, String contentType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 添加媒资文件到MinIO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath 文件路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:32</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String filePath, String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据桶和文件路径从minio下载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName 对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.io.File</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:31</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(File file, String bucket, String objectName)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 检查文件是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件的Md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt; false不存在，true存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:14</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 检查分块是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件的md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunkIndex 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 上传分块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunk 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 文件字节</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5,<span class="type">int</span> chunk,<span class="type">byte</span>[] bytes)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 合并分块</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId 机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:17</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId,String fileMd5,<span class="type">int</span> chunkTotal,UploadFileParamsDto uploadFileParamsDto)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据id查询文件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 文件id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 16:27</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="实现service方法impl-1"><a href="#实现service方法impl-1" class="headerlink" title="实现service方法impl"></a>实现service方法impl</h4><blockquote>
<p>同复制粘贴上传图片的 mediafilesserviceimpl</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.plugins.pagination.Page;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageParams;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.PageResult;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.QueryMediaParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileResultDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaFilesService;</span><br><span class="line"><span class="keyword">import</span> io.minio.GetObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.MinioClient;</span><br><span class="line"><span class="keyword">import</span> io.minio.PutObjectArgs;</span><br><span class="line"><span class="keyword">import</span> io.minio.UploadObjectArgs;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.compress.utils.IOUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 媒资文件管理业务实现类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaFilesServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;MediaFilesMapper, MediaFiles&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">MediaFilesService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MinioClient minioClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesService currentProxy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.bucket.files&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket_files;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;minio.bucket.videofiles&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket_videoFiles;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult&lt;MediaFiles&gt; <span class="title function_">queryMediaFiles</span><span class="params">(Long companyId, PageParams pageParams, QueryMediaParamsDto queryMediaParamsDto)</span> &#123;</span><br><span class="line">        <span class="comment">//构建查询条件对象</span></span><br><span class="line">        LambdaQueryWrapper&lt;MediaFiles&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(StringUtils.isNotBlank(queryMediaParamsDto.getFileType()), MediaFiles::getFileType, queryMediaParamsDto.getFileType());</span><br><span class="line"></span><br><span class="line">        queryWrapper.like(StringUtils.isNotBlank(queryMediaParamsDto.getFilename()), MediaFiles::getFilename, queryMediaParamsDto.getFilename());</span><br><span class="line">        <span class="comment">//分页对象</span></span><br><span class="line">        Page&lt;MediaFiles&gt; page = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        <span class="comment">// 查询数据内容获得结果</span></span><br><span class="line">        Page&lt;MediaFiles&gt; pageResult = mediaFilesMapper.selectPage(page, queryWrapper);</span><br><span class="line">        <span class="comment">// 获取数据列表</span></span><br><span class="line">        List&lt;MediaFiles&gt; list = pageResult.getRecords();</span><br><span class="line">        <span class="comment">// 获取数据总数</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">total</span> <span class="operator">=</span> pageResult.getTotal();</span><br><span class="line">        <span class="comment">// 构建结果集</span></span><br><span class="line">        PageResult&lt;MediaFiles&gt; mediaListResult = <span class="keyword">new</span> <span class="title class_">PageResult</span>&lt;&gt;(list, total, pageParams.getPageNo(), pageParams.getPageSize());</span><br><span class="line">        <span class="keyword">return</span> mediaListResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UploadFileResultDto <span class="title function_">uploadFile</span><span class="params">(Long companyId, UploadFileParamsDto uploadFileParamsDto, <span class="type">byte</span>[] bytes, String folder, String objectName)</span> &#123;</span><br><span class="line">        <span class="comment">//生成文件id，文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> DigestUtils.md5Hex(bytes);</span><br><span class="line">        <span class="comment">//得到文件的md5值</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(folder)) &#123;</span><br><span class="line">            <span class="comment">//自动生成目录的路径 按年月日生成，</span></span><br><span class="line">            folder = getFileFolder(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="literal">true</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (folder.indexOf(<span class="string">&quot;/&quot;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            folder = folder + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(objectName)) &#123;</span><br><span class="line">            <span class="comment">//如果objectName为空，使用文件的md5值为objectName</span></span><br><span class="line">            objectName = fileMd5 + filename.substring(filename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        objectName = folder + objectName;</span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//上传至文件系统</span></span><br><span class="line">            addMediaFilesToMinIO(bytes, bucket_files, objectName, uploadFileParamsDto.getContentType());</span><br><span class="line">            <span class="comment">//写入文件表</span></span><br><span class="line">            mediaFiles = currentProxy.addMediaFilesToDB(companyId, fileId, uploadFileParamsDto, bucket_files, objectName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//准备返回数据</span></span><br><span class="line">            <span class="type">UploadFileResultDto</span> <span class="variable">uploadFileResultDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileResultDto</span>();</span><br><span class="line">            BeanUtils.copyProperties(mediaFiles, uploadFileResultDto);</span><br><span class="line">            <span class="keyword">return</span> uploadFileResultDto;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.debug(<span class="string">&quot;上传文件失败：&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId           机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5             文件md5值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 上传文件的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files        桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName          对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件信息添加到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 20:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDB</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket_files, String objectName)</span> &#123;</span><br><span class="line">        <span class="comment">//保存到数据库</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//封装数据</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setBucket(bucket_files);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket_files + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002004&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取出文件扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> objectName.substring(objectName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//如果是avi则加入视频处理表</span></span><br><span class="line">        <span class="keyword">if</span> (extension.equalsIgnoreCase(<span class="string">&quot;.avi&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">            BeanUtils.copyProperties(mediaFiles, mediaProcess);</span><br><span class="line">            mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">            <span class="comment">//更新url为空</span></span><br><span class="line">            mediaFiles.setUrl(<span class="literal">null</span>);</span><br><span class="line">            mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mediaFiles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes        文件字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files 桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName   对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> contentType  内容类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件写入minIO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 20:58</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(<span class="type">byte</span>[] bytes, String bucket_files, String objectName, String contentType)</span> &#123;</span><br><span class="line">        <span class="comment">//转为流</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()</span><br><span class="line">                    .bucket(bucket_files)</span><br><span class="line">                    .object(objectName)</span><br><span class="line">                    <span class="comment">//InputStream stream, long objectSize 对象大小, long partSize 分片大小(-1表示5M,最大不要超过5T，最多10000)</span></span><br><span class="line">                    .stream(byteArrayInputStream, byteArrayInputStream.available(), -<span class="number">1</span>)</span><br><span class="line">                    .contentType(contentType)</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">//上传到minio</span></span><br><span class="line">            minioClient.putObject(putObjectArgs);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传文件到文件系统出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">        <span class="comment">//查询文件信息</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileMd5);</span><br><span class="line">        <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//桶</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaFiles.getBucket();</span><br><span class="line">            <span class="comment">//存储目录</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaFiles.getFilePath();</span><br><span class="line">            <span class="comment">//文件流</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">stream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stream = minioClient.getObject(</span><br><span class="line">                        GetObjectArgs.builder()</span><br><span class="line">                                .bucket(bucket)</span><br><span class="line">                                .object(filePath)</span><br><span class="line">                                .build());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//文件已存在</span></span><br><span class="line">                    <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//文件不存在</span></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunkIndex)</span> &#123;</span><br><span class="line">        <span class="comment">//得到分块文件目录</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        <span class="comment">//得到分块文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunkIndex;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//文件流</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket_videoFiles)</span><br><span class="line">                            .object(chunkFilePath)</span><br><span class="line">                            .build());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//分块已存在</span></span><br><span class="line">                <span class="keyword">return</span> RestResponse.success(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分块未存在</span></span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到分块文件的目录</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getChunkFileFolderPath</span><span class="params">(String fileMd5)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;chunk&quot;</span> + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadChunk</span><span class="params">(String fileMd5, <span class="type">int</span> chunk, <span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        <span class="comment">//得到分块文件的路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + chunk;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//将文件存储至minIO</span></span><br><span class="line">            addMediaFilesToMinIO(bytes, bucket_videoFiles, chunkFilePath, <span class="string">&quot;application/octet-stream&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传过程出错请重试&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检查所有分块是否上传完毕</span></span><br><span class="line">    <span class="keyword">private</span> File[] checkChunkStatus(String fileMd5, <span class="type">int</span> chunkTotal) &#123;</span><br><span class="line">        <span class="comment">//得到分块文件的目录路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">chunkFileFolderPath</span> <span class="operator">=</span> getChunkFileFolderPath(fileMd5);</span><br><span class="line">        File[] files = <span class="keyword">new</span> <span class="title class_">File</span>[chunkTotal];</span><br><span class="line">        <span class="comment">//检查分块文件是否上传完毕</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; chunkTotal; i++) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">chunkFilePath</span> <span class="operator">=</span> chunkFileFolderPath + i;</span><br><span class="line">            <span class="comment">//下载文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">chunkFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                chunkFile = File.createTempFile(<span class="string">&quot;chunk&quot;</span> + i, <span class="literal">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;下载分块时创建临时文件出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            downloadFileFromMinIO(chunkFile, bucket_videoFiles, chunkFilePath);</span><br><span class="line">            files[i] = chunkFile;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> files;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据桶和文件路径从minio下载文件</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">downloadFileFromMinIO</span><span class="params">(File file, String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = minioClient.getObject(</span><br><span class="line">                    GetObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(objectName)</span><br><span class="line">                            .build());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileOutputStream = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">                IOUtils.copy(fileInputStream, fileOutputStream);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;下载文件&quot;</span> + objectName + <span class="string">&quot;出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;文件不存在&quot;</span> + objectName);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileInputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (fileOutputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileOutputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(Long companyId, String fileMd5, <span class="type">int</span> chunkTotal, UploadFileParamsDto uploadFileParamsDto)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> uploadFileParamsDto.getFilename();</span><br><span class="line">        <span class="comment">//下载所有分块文件</span></span><br><span class="line">        File[] chunkFiles = checkChunkStatus(fileMd5, chunkTotal);</span><br><span class="line">        <span class="comment">//扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//创建临时文件作为合并文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">mergeFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mergeFile = File.createTempFile(fileMd5, extName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;合并文件过程中创建临时文件出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//开始合并</span></span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">raf_write</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(mergeFile, <span class="string">&quot;rw&quot;</span>);) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File chunkFile : chunkFiles) &#123;</span><br><span class="line">                    <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">chunkFileStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(chunkFile);) &#123;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span> ((len = chunkFileStream.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="comment">//向合并后的文件写</span></span><br><span class="line">                            raf_write.write(b, <span class="number">0</span>, len);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件过程中出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            log.debug(<span class="string">&quot;合并文件完成&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            uploadFileParamsDto.setFileSize(mergeFile.length());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">mergeFileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mergeFile);) &#123;</span><br><span class="line">                <span class="comment">//对文件进行校验，通过比较md5值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">newFileMd5</span> <span class="operator">=</span> DigestUtils.md5Hex(mergeFileInputStream);</span><br><span class="line">                <span class="keyword">if</span> (!fileMd5.equalsIgnoreCase(newFileMd5)) &#123;</span><br><span class="line">                    <span class="comment">//校验失败</span></span><br><span class="line">                    XueChengException.cast(<span class="string">&quot;合并文件校验失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;合并文件校验通过&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">//校验失败</span></span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件校验异常&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将临时文件上传至minio</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">mergeFilePath</span> <span class="operator">=</span> getFilePathByMd5(fileMd5, extName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//上传文件到minIO</span></span><br><span class="line">                addMediaFilesToMinIO(mergeFile.getAbsolutePath(), bucket_videoFiles, mergeFilePath);</span><br><span class="line">                log.debug(<span class="string">&quot;合并文件上传MinIO完成&#123;&#125;&quot;</span>, mergeFile.getAbsolutePath());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;合并文件时上传文件出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//入数据库</span></span><br><span class="line">            <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> addMediaFilesToDB(companyId, fileMd5, uploadFileParamsDto, bucket_videoFiles, mergeFilePath);</span><br><span class="line">            <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span>) &#123;</span><br><span class="line">                XueChengException.cast(<span class="string">&quot;媒资文件入库出错&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> RestResponse.success();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//删除临时文件</span></span><br><span class="line">            <span class="keyword">for</span> (File file : chunkFiles) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    file.delete();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mergeFile.delete();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePathByMd5</span><span class="params">(String fileMd5, String fileExt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileMd5.substring(<span class="number">0</span>, <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>, <span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> + fileMd5 + fileExt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将文件上传到minIO，传入文件绝对路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addMediaFilesToMinIO</span><span class="params">(String filePath, String bucket, String objectName)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            minioClient.uploadObject(</span><br><span class="line">                    UploadObjectArgs.builder()</span><br><span class="line">                            .bucket(bucket)</span><br><span class="line">                            .object(objectName)</span><br><span class="line">                            .filename(filePath)</span><br><span class="line">                            .build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;上传文件到文件系统出错&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> date 日期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据日期拼接目录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/1/29 17:48</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFileFolder</span><span class="params">(Date date, <span class="type">boolean</span> year, <span class="type">boolean</span> month, <span class="type">boolean</span> day)</span> &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">        <span class="comment">//获取当前日期字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dateString</span> <span class="operator">=</span> sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//取出年、月、日</span></span><br><span class="line">        String[] dateStringArray = dateString.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">folderString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="keyword">if</span> (year) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">0</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (month) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">1</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (day) &#123;</span><br><span class="line">            folderString.append(dateStringArray[<span class="number">2</span>]);</span><br><span class="line">            folderString.append(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> folderString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="api-接口定义-1"><a href="#api-接口定义-1" class="headerlink" title="api-接口定义"></a>api-接口定义</h3><p>根据上传视频流程，在media-api中新创建controller，定义如下接口：</p>
<hr>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaApi.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfo;</span><br><span class="line"><span class="keyword">import</span> com.j256.simplemagic.ContentInfoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.exception.XueChengException;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.model.RestResponse;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.dto.UploadFileParamsDto;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaFilesService;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 大文件上传接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/2 14:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigFilesController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesService mediaFilesService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 文件上传前检查文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:12</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkfile&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkfile</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesService.checkFile(fileMd5);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 分块文件上传前的检测</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunk 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.Boolean&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:33</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/checkchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;Boolean&gt; <span class="title function_">checkchunk</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesService.checkChunk(fileMd5, chunk);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 上传分块文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> file 文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunk 分块序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:35</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/uploadchunk&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">uploadchunk</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;chunk&quot;)</span> <span class="type">int</span> chunk</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> mediaFilesService.uploadChunk(fileMd5,chunk,file.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 合并文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5 文件md5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chunkTotal 分块总和</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 14:36</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload/mergechunks&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse <span class="title function_">mergechunks</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileMd5&quot;)</span> String fileMd5,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;fileName&quot;)</span> String fileName,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(&quot;chunkTotal&quot;)</span> <span class="type">int</span> chunkTotal</span></span><br><span class="line"><span class="params">    )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">companyId</span> <span class="operator">=</span> <span class="number">1232141425L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">UploadFileParamsDto</span> <span class="variable">uploadFileParamsDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UploadFileParamsDto</span>();</span><br><span class="line">        uploadFileParamsDto.setFileType(<span class="string">&quot;001002&quot;</span>);</span><br><span class="line">        uploadFileParamsDto.setTags(<span class="string">&quot;课程视频&quot;</span>);</span><br><span class="line">        uploadFileParamsDto.setRemark(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        uploadFileParamsDto.setFilename(fileName);</span><br><span class="line">        <span class="type">ContentInfo</span> <span class="variable">extensionMatch</span> <span class="operator">=</span> ContentInfoUtil.findExtensionMatch(fileName);</span><br><span class="line">        <span class="type">String</span> <span class="variable">mimeType</span> <span class="operator">=</span> extensionMatch.getMimeType();</span><br><span class="line">        uploadFileParamsDto.setContentType(mimeType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> mediaFilesService.mergechunks(companyId, fileMd5, chunkTotal, uploadFileParamsDto);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 预览文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mediaId 文件id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.String&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/2 16:26</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesService.getFileById(mediaId);</span><br><span class="line">        <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;视频并未进行转码处理&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="接口测试-2"><a href="#接口测试-2" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h3><p>如果是单个接口测试使用httpclient</p>
<p><strong>建议直接前后端联调，更好看到结果</strong></p>
<hr>
 <figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">### 检查文件</span><br><span class="line">POST&#123;&#123;media_host&#125;&#125;/media/upload/register</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded;</span><br><span class="line"></span><br><span class="line">fileMd5=查表找filemd5</span><br><span class="line"></span><br><span class="line">### 上传分块前检查</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/checkchunk</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded;</span><br><span class="line"></span><br><span class="line">fileMd5=c5c75d70f382e6016d2f506d134eee11&amp;chunk=0</span><br><span class="line"></span><br><span class="line">### 上传分块文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/uploadchunk?fileMd5=c5c75d70f382e6016d2f506d134eee11&amp;chunk=1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=WebAppBoundary</span><br><span class="line"></span><br><span class="line">--WebAppBoundary</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>form-data; name=&quot;file&quot;; filename=&quot;1&quot;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt; E:/ffmpeg_test/chunks/1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 合并文件</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/upload/mergechunks</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded;</span><br><span class="line"></span><br><span class="line">fileMd5=dcb37b85c9c03fc5243e20ab4dfbc1c8&amp;fileName=8.avi&amp;chunkTotal=1</span><br></pre></td></tr></table></figure>

<p>下边介绍采用前后联调：</p>
<ol>
<li>首先在每个接口层方法上打开断点</li>
</ol>
<p>在前端上传视频，观察接口层是否收到参数。</p>
<ol start="2">
<li><p>进入service方法逐行跟踪。</p>
</li>
<li><p>断点续传测试</p>
</li>
</ol>
<p>上传一部分后，停止刷新浏览器再重新上传，通过浏览器日志发现已经上传过的分块不再重新上传</p>
<h2 id="文件预览"><a href="#文件预览" class="headerlink" title="文件预览"></a><strong>文件预览</strong></h2><h3 id="需求分析-2"><a href="#需求分析-2" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h3><p>图片上传成功、视频上传成功可以通过预览功能查看文件的内容。</p>
<p>预览的方式是通过浏览器直接打文件，对于图片和浏览器支持的视频格式的视频文件可以直接预览。</p>
<p>业务流程如下：</p>
<ol>
<li><p>前端请求接口层预览文件</p>
</li>
<li><p>接口层将文件id传递给服务层</p>
</li>
<li><p>服务层使用文件id查询媒资数据库文件表，获取文件的url</p>
</li>
<li><p>接口层将文件url返回给前端，通过浏览器打开URL。</p>
</li>
</ol>
<h4 id="接口定义-1"><a href="#接口定义-1" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h4><p>根据需求分析定义接口如下：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">    <span class="meta">@ApiOperation(&quot;预览文件&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="model-生成DTO-2"><a href="#model-生成DTO-2" class="headerlink" title="model-生成DTO"></a><strong>model-生成DTO</strong></h3><p>无新增配置，略</p>
<h3 id="service-接口开发-2"><a href="#service-接口开发-2" class="headerlink" title="service-接口开发"></a>service-接口开发</h3><h4 id="定义service方法-2"><a href="#定义service方法-2" class="headerlink" title="定义service方法"></a>定义service方法</h4><p>还是在media-service中创建接口</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 根据id查询文件信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id 文件id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2023/2/2 16:27</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="实现service方法impl-2"><a href="#实现service方法impl-2" class="headerlink" title="实现service方法impl"></a>实现service方法impl</h4><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> MediaFiles <span class="title function_">getFileById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mediaFilesMapper.selectById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>api-接口定义：</p>
<p>在 bigFilescontroller中完善：</p>
<hr>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@description</span> 预览文件</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> mediaId 文件id</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> com.xuecheng.base.model.RestResponse&lt;java.lang.String&gt;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@date</span> 2023/2/2 16:26</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="meta">@GetMapping(&quot;/preview/&#123;mediaId&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> RestResponse&lt;String&gt; <span class="title function_">getPlayUrlByMediaId</span><span class="params">(<span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line">       <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesService.getFileById(mediaId);</span><br><span class="line">       <span class="keyword">if</span> (mediaFiles == <span class="literal">null</span> || StringUtils.isEmpty(mediaFiles.getUrl()))&#123;</span><br><span class="line">           XueChengException.cast(<span class="string">&quot;视频并未进行转码处理&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> RestResponse.success(mediaFiles.getUrl());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="接口测试-3"><a href="#接口测试-3" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h3><p>使用前后端联调</p>
<ul>
<li><p>上传mp4视频文件，预览文件。</p>
</li>
<li><p>上传图片文件，预览文件。</p>
</li>
</ul>
<p>对于无法预览的视频文件，稍后通过视频处理对视频转码。</p>
<h2 id="视频处理"><a href="#视频处理" class="headerlink" title="视频处理"></a><strong>视频处理</strong></h2><h3 id="FFmpeg-的基本使用"><a href="#FFmpeg-的基本使用" class="headerlink" title="FFmpeg 的基本使用"></a><strong>FFmpeg 的基本使用</strong></h3><p>我们将视频录制完成后，使用视频编码软件对视频进行编码，本项目使用FFmpeg对视频进行编码 。</p>
<p>FFmpeg被许多开源项目采用，QQ影音、暴风影音、VLC等。</p>
<p>下载：FFmpeg <a target="_blank" rel="noopener" href="https://www.ffmpeg.org/download.html#build-windows">https://www.ffmpeg.org/download.html#build-windows</a></p>
<p>请从课程资料目录解压ffmpeg.zip,并将解压得到的exe文件加入环境变量。</p>
<p>测试是否正常：cmd运行 ffmpeg -v</p>
<p>安装成功，作下简单测试：将一个.avi文件转成mp4、mp3、gif等。</p>
<p>比如我们将nacos.avi文件转成mp4，运行如下命令：</p>
<p>ffmpeg -i nacos.avi nacos.mp4</p>
<p>转成mp3：ffmpeg -i nacos.avi nacos.mp3</p>
<p>转成gif：ffmpeg -i nacos.avi nacos.gif</p>
<p>官方文档（英文）：<a target="_blank" rel="noopener" href="http://ffmpeg.org/ffmpeg.html">http://ffmpeg.org/ffmpeg.html</a></p>
<h3 id="分布式任务处理概念"><a href="#分布式任务处理概念" class="headerlink" title="分布式任务处理概念"></a><strong>分布式任务处理概念</strong></h3><h4 id="什么是分布式任务调度"><a href="#什么是分布式任务调度" class="headerlink" title="什么是分布式任务调度"></a><strong>什么是分布式任务调度</strong></h4><blockquote>
<p>如何去高效处理一批任务呢？</p>
</blockquote>
<ol>
<li>多线程</li>
</ol>
<p>多线程是充分利用单机的资源。</p>
<ol start="2">
<li>分布式加多线程</li>
</ol>
<p>充分利用我台计算机，每台计算机多线程处理。</p>
<p>方案2可扩展性更强，是一种分布式任务调度的处理方案。</p>
<p>在思考什么是分布式任务调度之前，我们可以先思考一下下面业务场景的解决方案：</p>
<ul>
<li><p>某电商系统需要在每天上午10点，下午3点，晚上8点发放一批优惠券。</p>
</li>
<li><p>某财务系统需要在每天上午10点前结算前一天的账单数据，统计汇总。</p>
</li>
<li><p>某电商平台每天凌晨3点，要对订单中的无效订单进行清理。</p>
</li>
<li><p>12306网站会根据车次不同，设置几个时间点分批次放票。</p>
</li>
<li><p>电商整点抢购，商品价格某天上午8点整开始优惠。</p>
</li>
<li><p>商品成功发货后，需要向客户发送短信提醒。</p>
</li>
</ul>
<p>以上这些场景，就是任务调度所需要解决的问题。</p>
<p><strong>任务调度顾名思义，就是对任务的调度，它是指系统为了完成特定业务，基于给定时间点，给定时间间隔或者给定执行次数自动执行任务。</strong></p>
<blockquote>
<p>如何实现任务调度？</p>
</blockquote>
<p><strong>多线程方式实现：</strong></p>
<p>学过多线程的同学，可能会想到，我们可以开启一个线程，每sleep一段时间，就去检查是否已到预期执行时间。</p>
<p>以下代码简单实现了任务调度的功能：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;    </span><br><span class="line">    <span class="comment">//任务执行间隔时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timeInterval</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(timeInterval);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">    thread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>上面的代码实现了按一定的间隔时间执行任务调度的功能。</p>
<p>Jdk也为我们提供了相关支持，如Timer、ScheduledExecutor，下边我们了解下。</p>
<p><strong>Timer方式实现</strong>：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();  </span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;  </span><br><span class="line">            <span class="comment">//TODO：something</span></span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;, <span class="number">1000</span>, <span class="number">2000</span>);  <span class="comment">//1秒后开始调度，每2秒执行一次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Timer的优点在于简单易用，每个Timer对应一个线程，因此可以同时启动多个Timer并行执行多个任务，同一个Timer中的任务是串行执行。</p>
<p><strong>ScheduledExecutor方式实现</strong>：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">10</span>);</span><br><span class="line">    service.scheduleAtFixedRate(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">//TODO：something</span></span><br><span class="line">                System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>,</span><br><span class="line">        <span class="number">2</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java 5 推出了基于线程池设计的ScheduledExecutor，其设计思想是，每一个被调度的任务都会由线程池中一个线程去执行，因此任务是并发执行的，相互之间不会受到干扰。</p>
<p>Timer 和 ScheduledExecutor都仅能提供基于开始时间与重复间隔的任务调度，<strong>不能胜任更加复杂的调度需求</strong>。比如，设置每月第一天凌晨1点执行任务、复杂调度任务的管理、任务间传递数据等等。</p>
<p><strong>Quartz</strong><br>Quartz是一个功能强大的任务调度框架，它可以满足更多更复杂的调度需求，Quartz设计的核心类包括 Scheduler, Job 以及 Trigger。其中，Job负责定义需要执行的任务，Trigger 负责设置调度策略，Scheduler将二者组装在一起，并触发任务开始执行。Quartz支持简单的按时间间隔调度、还支持按日历调度方式，通过设置CronTrigger表达式（包括：秒、分、时、日、月、周、年）进行任务调度。</p>
<p><strong>第三方Quartz方式实现</strong>：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String [] agrs)</span> <span class="keyword">throws</span> SchedulerException &#123;</span><br><span class="line">    <span class="comment">//创建一个Scheduler</span></span><br><span class="line">    <span class="type">SchedulerFactory</span> <span class="variable">schedulerFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StdSchedulerFactory</span>();</span><br><span class="line">    <span class="type">Scheduler</span> <span class="variable">scheduler</span> <span class="operator">=</span> schedulerFactory.getScheduler();</span><br><span class="line">    <span class="comment">//创建JobDetail</span></span><br><span class="line">    <span class="type">JobBuilder</span> <span class="variable">jobDetailBuilder</span> <span class="operator">=</span> JobBuilder.newJob(MyJob.class);</span><br><span class="line">    jobDetailBuilder.withIdentity(<span class="string">&quot;jobName&quot;</span>,<span class="string">&quot;jobGroupName&quot;</span>);</span><br><span class="line">    <span class="type">JobDetail</span> <span class="variable">jobDetail</span> <span class="operator">=</span> jobDetailBuilder.build();</span><br><span class="line">    <span class="comment">//创建触发的CronTrigger 支持按日历调度</span></span><br><span class="line">    <span class="type">CronTrigger</span> <span class="variable">trigger</span> <span class="operator">=</span> TriggerBuilder.newTrigger()</span><br><span class="line">        .withIdentity(<span class="string">&quot;triggerName&quot;</span>, <span class="string">&quot;triggerGroupName&quot;</span>)</span><br><span class="line">        .startNow()</span><br><span class="line">        .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/2 * * * * ?&quot;</span>))</span><br><span class="line">        .build();</span><br><span class="line">    <span class="comment">//创建触发的SimpleTrigger 简单的间隔调度</span></span><br><span class="line">    <span class="comment">/*SimpleTrigger trigger = TriggerBuilder.newTrigger()</span></span><br><span class="line"><span class="comment">                .withIdentity(&quot;triggerName&quot;,&quot;triggerGroupName&quot;)</span></span><br><span class="line"><span class="comment">                .startNow()</span></span><br><span class="line"><span class="comment">                .withSchedule(SimpleScheduleBuilder</span></span><br><span class="line"><span class="comment">                        .simpleSchedule()</span></span><br><span class="line"><span class="comment">                        .withIntervalInSeconds(2)</span></span><br><span class="line"><span class="comment">                        .repeatForever())</span></span><br><span class="line"><span class="comment">                .build();*/</span></span><br><span class="line">    scheduler.scheduleJob(jobDetail,trigger);</span><br><span class="line">    scheduler.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyJob</span> <span class="keyword">implements</span> <span class="title class_">Job</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(JobExecutionContext jobExecutionContext)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;todo something&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>通过以上内容我们学习了什么是任务调度，任务调度所解决的问题，以及任务调度的多种实现方式。</p>
<blockquote>
<p><strong>什么是分布式任务调度？</strong></p>
</blockquote>
<p>通常任务调度的程序是集成在应用中的，比如：优惠卷服务中包括了定时发放优惠卷的的调度程序，结算服务中包括了定期生成报表的任务调度程序，由于采用分布式架构，一个服务往往会部署多个冗余实例来运行我们的业务，在这种分布式系统环境下运行任务调度，我们称之为<strong>分布式任务调度</strong>。</p>
<blockquote>
<p><strong>分布式调度要实现的目标：</strong></p>
</blockquote>
<p>不管是任务调度程序集成在应用程序中，还是单独构建的任务调度系统，如果采用分布式调度任务的方式就相当于将任务调度程序分布式构建，这样就可以具有分布式系统的特点，并且提高任务的调度处理能力：</p>
<ol>
<li>并行任务调度</li>
</ol>
<p>并行任务调度实现靠多线程，如果有大量任务需要调度，此时光靠多线程就会有瓶颈了，因为一台计算机CPU的处理能力是有限的。</p>
<p>如果将任务调度程序分布式部署，每个结点还可以部署为集群，这样就可以让多台计算机共同去完成任务调度，我们可以将任务分割为若干个分片，由不同的实例并行执行，来提高任务调度的处理效率。</p>
<ol start="2">
<li>高可用</li>
</ol>
<p>若某一个实例宕机，不影响其他实例来执行任务。</p>
<ol start="3">
<li>弹性扩容</li>
</ol>
<p>当集群中增加实例就可以提高并执行任务的处理效率。</p>
<ol start="4">
<li>任务管理与监测</li>
</ol>
<p>对系统中存在的所有定时任务进行统一的管理及监测。让开发人员及运维人员能够时刻了解任务执行情况，从而做出快速的应急处理响应。</p>
<ol start="5">
<li>避免任务重复执行</li>
</ol>
<p>当任务调度以集群方式部署，同一个任务调度可能会执行多次，比如在上面提到的电商系统中到点发优惠券的例子，就会发放多次优惠券，对公司造成很多损失，所以我们需要控制相同的任务在多个运行实例上只执行一次。</p>
<h3 id="XXL-JOB介绍"><a href="#XXL-JOB介绍" class="headerlink" title="XXL-JOB介绍"></a><strong>XXL-JOB介绍</strong></h3><p>XXL-JOB是一个轻量级分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">https://www.xuxueli.com/xxl-job/</a></p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B">https://www.xuxueli.com/xxl-job/#%E3%80%8A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0XXL-JOB%E3%80%8B</a></p>
<p>XXL-JOB主要有调度中心、执行器、任务：</p>
<ul>
<li><p><strong>调度中心：</strong></p>
<ul>
<li><p>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码；</p>
</li>
<li><p>主要职责为执行器管理、任务管理、监控运维、日志管理等</p>
</li>
</ul>
</li>
<li><p><strong>任务执行器：</strong></p>
<ul>
<li><p>负责接收调度请求并执行任务逻辑；</p>
</li>
<li><p>只要职责是注册服务、任务执行服务（接收到任务后会放入线程池中的任务队列）、执行结果上报、日志服务等</p>
</li>
</ul>
</li>
<li><p><strong>任务：</strong>负责执行具体的业务处理。</p>
<ul>
<li>调度中心与执行器之间的工作流程如下：</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2023/02/04/M9DruyX8QV2FPSR.png" alt="image-20230204134128242"></p>
<p><strong>执行流程：</strong></p>
<ol>
<li><p>任务执行器根据配置的调度中心的地址，自动注册到调度中心</p>
</li>
<li><p>达到任务触发条件，调度中心下发任务</p>
</li>
<li><p>执行器基于线程池执行任务，并把执行结果放入内存队列中、把执行日志写入日志文件中</p>
</li>
<li><p>执行器消费内存队列中的执行结果，主动上报给调度中心</p>
</li>
<li><p>当用户在调度中心查看任务日志，调度中心请求任务执行器，任务执行器读取任务日志文件并返回日志详情</p>
</li>
</ol>
<h3 id="搭建XXL-JOB"><a href="#搭建XXL-JOB" class="headerlink" title="搭建XXL-JOB"></a><strong>搭建XXL-JOB</strong></h3><h4 id="下载XXL-JOB"><a href="#下载XXL-JOB" class="headerlink" title="下载XXL-JOB"></a>下载XXL-JOB</h4><p>GitHub：<a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">https://github.com/xuxueli/xxl-job</a></p>
<p>码云：<a target="_blank" rel="noopener" href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></p>
<p>项目使用2.3.1版本：<br><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job/releases/tag/2.3.1">https://github.com/xuxueli/xxl-job/releases/tag/2.3.1</a></p>
<p>也可从课程资料目录获取，解压xxl-job-2.3.1.zip，使用IDEA打开解压后的目录</p>
<ul>
<li><p>xxl-job-admin：调度中心</p>
</li>
<li><p>xxl-job-core：公共依赖</p>
</li>
<li><p>xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用）</p>
<ul>
<li><p>xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</p>
</li>
<li><p>xxl-job-executor-sample-frameless：无框架版本；</p>
</li>
</ul>
</li>
</ul>
<p>doc :文档资料，包含数据库脚本</p>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>首先修改doc下的tables_xxl_job.sql脚本内容：</p>
<hr>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">CREATE</span> database if <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `xxl_job_2<span class="number">.3</span><span class="number">.1</span>` <span class="keyword">default</span> <span class="type">character</span> <span class="keyword">set</span> utf8mb4 <span class="keyword">collate</span> utf8mb4_unicode_ci;</span><br><span class="line">use `xxl_job_2<span class="number">.3</span><span class="number">.1</span>`;</span><br></pre></td></tr></table></figure>

<hr>
<p>将tables_xxl_job.sql脚本导入xxl_job_2.3.1数据库</p>
<h4 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h4><p>修改xxl-job-admin任务调度中心下application.properties的配置文件内容，修改数据库链接地址：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line">    spring.datasource.url=jdbc:mysql:<span class="comment">//mysqlIP:3306/xxl_job_2.3.1?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">	spring.datasource.username=账号</span><br><span class="line">    spring.datasource.password=密码</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="启动工程"><a href="#启动工程" class="headerlink" title="启动工程"></a>启动工程</h4><p>启动xxl-job-admin任务调度中心，运行com.xxl.job.admin.XxlJobAdminApplication</p>
<p>启动成功访问<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a></p>
<p>账号：admin</p>
<p>密码：123456</p>
<p>到此调度中心启动成功。</p>
<h3 id="配置执行器"><a href="#配置执行器" class="headerlink" title="配置执行器"></a><strong>配置执行器</strong></h3><p>执行器负责与调度中心通信接收调度中心发起的任务调度请求。</p>
<h4 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>在media-service工程添加依赖，在项目的父工程已约定了版本2.3.1</p>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XML</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="配置nacos信息"><a href="#配置nacos信息" class="headerlink" title="配置nacos信息"></a>配置nacos信息</h4><p>在nacos下的media-service-dev.yaml下配置xxl-job</p>
<hr>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">YAML</span></span><br><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="attr">admin:</span> </span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://localhost:端口号/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">media-process-service</span></span><br><span class="line">      <span class="attr">address:</span> </span><br><span class="line">      <span class="attr">ip:</span> </span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">default_token</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意配置中的appname这是执行器的应用名，稍后在调度中心配置执行器时要使用。</p>
</blockquote>
<h4 id="配置xxl-job执行器"><a href="#配置xxl-job执行器" class="headerlink" title="配置xxl-job执行器"></a>配置xxl-job执行器</h4><p>将示例工程下配置类：</p>
<p><img src="https://s2.loli.net/2023/02/04/k1ylGY5rFxOIKWU.png" alt="image-20230204134833634"></p>
<p>拷贝到media-service工程的config文件夹下：</p>
<p><img src="https://s2.loli.net/2023/02/04/TazJ628SRNHqW7l.png" alt="image-20230204134920409"></p>
<h4 id="添加执行器"><a href="#添加执行器" class="headerlink" title="添加执行器"></a>添加执行器</h4><p>进入调度中心添加执行器</p>
<p><img src="https://s2.loli.net/2023/02/04/Qnmd4OP2FZthf89.png" alt="image-20230204134952095"></p>
<p>点击新增，填写执行器信息，appname是前边在nacos中配置xxl信息时指定的执行器的应用名。</p>
<p><img src="https://s2.loli.net/2023/02/04/48kOQbyDYfZCods.png" alt="image-20230204135006426"></p>
<p>添加成功：</p>
<p><img src="https://s2.loli.net/2023/02/04/XAuhLnmsZoJwWc8.png" alt="image-20230204135023768"></p>
<p>到此完成媒资管理模块service工程配置xxl-job执行器，在xxl-job调度中心添加执行器</p>
<h4 id="测试连接"><a href="#测试连接" class="headerlink" title="测试连接"></a>测试连接</h4><p>准备测试执行器与调度中心是否正常通信，因为接口工程依赖了service工程，所以启动media-api工程。</p>
<p>启动后观察日志，出现下边的日志表示执行器在调度中心注册成功</p>
<p><img src="https://s2.loli.net/2023/02/04/zcwdbTZkiqJtmDo.png" alt="image-20230204135116819"></p>
<p>同时观察调度中心中的执行器界面</p>
<p><img src="https://s2.loli.net/2023/02/04/75KYTLDtOiPzvr1.png" alt="image-20230204135132368"></p>
<p>在线机器地址处已显示1个执行器。</p>
<p><strong>测试任务类</strong></p>
<ol>
<li>在media-service包下新建jobhandler存放任务类，下边参考示例工程编写一个任务类</li>
</ol>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试执行器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/2 22:02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SampleJob</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;testJob&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJob</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;开始执行.....&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2、分片广播任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;shardingJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shardingJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;分片参数：当前分片序号 = &#123;&#125;, 总分片数 = &#123;&#125;&quot;</span>, shardIndex, shardTotal);</span><br><span class="line">        log.info(<span class="string">&quot;开始执行第&quot;</span>+shardIndex+<span class="string">&quot;批任务&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>在调度中心添加任务，进入任务管理</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/xT28MLIQNuqyCdR.png" alt="image-20230204135332870"></p>
<p>点击新增，填写任务信息</p>
<p><img src="https://s2.loli.net/2023/02/04/WafAbVhr18Lwn4Y.png" alt="image-20230204135349522"></p>
<p><strong>注意红色标记处</strong>：</p>
<ul>
<li><p>调度类型选择Cron，并配置Cron表达式设置定时策略。</p>
</li>
<li><p>运行模式有BEAN和GLUE，bean模式较常用就是在项目工程中编写执行器的任务代码，GLUE是将任务代码编写在调度中心。</p>
</li>
<li><p>JobHandler任务方法名填写@XxlJob注解中的名称。</p>
</li>
</ul>
<ol start="3">
<li>添加成功，启动任务</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/96FA8uLfXzckspy.png" alt="image-20230204135451690"></p>
<p>通过调度日志查看任务执行情况</p>
<p><img src="https://s2.loli.net/2023/02/04/PsAVf4QwbG6eR37.png" alt="image-20230204135505397"></p>
<ol start="4">
<li>启动媒资管理的service工程，启动执行器，观察执行器方法的执行。</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/LmTndUcAe3DlzC8.png" alt="image-20230204135528438"></p>
<ol start="5">
<li>如果要停止任务需要在调度中心操作</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/tnMCBhcH2vR1ZeT.png" alt="image-20230204135552671"></p>
<ol start="6">
<li>任务跑一段时间注意清理日志</li>
</ol>
<p><img src="https://s2.loli.net/2023/02/04/XoHv23WphI9wxGE.png" alt="image-20230204135615285"></p>
<h3 id="需求分析-3"><a href="#需求分析-3" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h3><h4 id="作业分片方案"><a href="#作业分片方案" class="headerlink" title="作业分片方案"></a><strong>作业分片方案</strong></h4><p>掌握了xxl-job的作业分片调度方式，下边思考如何分布式去执行学成在线平台中的视频处理任务。</p>
<p>任务添加成功后，对于要处理的任务会添加到待处理任务表中，现在启动多个执行器实例去查询这些待处理任务，此时如何保证多个执行器不会重复执行任务？</p>
<p>执行器收到调度请求后各自己查询属于自己的任务，这样就保证了执行器之间不会重复执行任务。</p>
<p>xxl-job设计作业分片就是为了分布式执行任务，XXL-JOB并不直接提供数据处理的功能，它只会给执行器分配好分片序号并向执行器传递分片总数、分片序号这些参数，开发者需要自行处理分片项与真实数据的对应关系。</p>
<p>每个执行器收到广播任务有两个参数：分片总数、分片序号。每个执行从数据表取任务时可以让任务id<br>模上 分片总数，如果等于分片序号则执行此任务。</p>
<p>上边两个执行器实例那么分片总数为2，序号为0、1，从任务1开始，如下：</p>
<p>1 % 2 &#x3D; 1 执行器2执行</p>
<p>2 % 2 &#x3D; 0 执行器1执行</p>
<p>3 % 2 &#x3D; 1 执行器2执行</p>
<p>以此类推.</p>
<h4 id="保证任务不重复执行"><a href="#保证任务不重复执行" class="headerlink" title="保证任务不重复执行"></a><strong>保证任务不重复执行</strong></h4><p>通过作业分片的方式保证了执行器之间分配的任务不重复，如果同一个执行器在处理一个视频还没有完成，此时调度中心又一次请求调度，为了不重复处理同一个视频该怎么办？</p>
<ol>
<li>首先配置调度过期策略，查看文档如下：</li>
</ol>
<p>调度过期策略：</p>
<ul>
<li><p>忽略：调度过期后，忽略过期的任务，从当前时间开始重新计算下次触发时间；</p>
</li>
<li><p>立即执行一次：调度过期后，立即执行一次，并从当前时间开始重新计算下次触发时间；</p>
</li>
<li><p>阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</p>
</li>
</ul>
<p>这里我们选择忽略，如果立即执行一次可能会重复调度。</p>
<ol start="2">
<li>看阻塞处理策略，阻塞处理策略就是当前执行器正在执行任务还没有结束，此时调度时间到该如何处理，查看文档如下：</li>
</ol>
<ul>
<li>单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</li>
<li>丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</li>
<li>覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</li>
</ul>
<p>这里选择 丢弃后续调度，避免重复调度。</p>
<ol start="3">
<li>注意保证任务处理的幂等性</li>
</ol>
<blockquote>
<p>什么是任务的幂等性？</p>
</blockquote>
<p><strong>任务的幂等性</strong>是指：对于数据的操作不论多少次，操作的结果始终是一致的。执行器接收调度请求去执行任务，要有办法去判断该任务是否处理完成，如果处理完则不再处理，即使重复调度处理相同的任务也不能重复处理相同的视频。</p>
<blockquote>
<p>什么是幂等性？</p>
</blockquote>
<p>它描述了一次和多次请求某一个资源对于资源本身应该具有同样的结果。幂等性是为了解决重复提交问题，比如：恶意刷单，重复支付等。</p>
<blockquote>
<p>解决幂等性常用的方案：</p>
</blockquote>
<ol>
<li><p>数据库约束，比如：唯一索引，主键。</p>
</li>
<li><p>乐观锁，常用于数据库，更新数据时根据乐观锁状态去更新。</p>
</li>
<li><p>唯一序列号，操作传递一个唯一序列号，操作时判断与该序列号相等则执行。</p>
</li>
</ol>
<p>这里我们在数据库视频处理表中添加处理状态字段，视频处理完成更新状态为完成，执行视频处理前判断状态是否完成，如果完成则不再处理。</p>
<h4 id="业务流程-1"><a href="#业务流程-1" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h4><p>确定了分片方案，下边梳理整个视频上传及处理的业务流程。</p>
<p><img src="https://s2.loli.net/2023/02/04/NPgzZBRHfY1DtU2.png" alt="image-20230204140310947"></p>
<p>视频处理的详细流程如下：</p>
<p><img src="https://s2.loli.net/2023/02/04/dPHCqEgTeVbZvUj.png" alt="image-20230204140329560"></p>
<ol>
<li><p>任务调度中心广播作业分片。</p>
</li>
<li><p>执行器收到广播作业分片，从数据库读取待处理任务。</p>
</li>
<li><p>执行器根据任务内容从MinIO下载要处理的文件。</p>
</li>
<li><p>执行器启动多线程去处理任务。</p>
</li>
<li><p>任务处理完成，上传处理后的视频到MinIO。</p>
</li>
<li><p>将更新任务处理结果，如果视频处理完成除了更新任务处理结果以外还要<strong>将文件的访问地址更新至任务处理表及文件表中，最后将任务完成记录写入历史表</strong>。</p>
</li>
</ol>
<h3 id="model-生成DTO-3"><a href="#model-生成DTO-3" class="headerlink" title="model-生成DTO"></a><strong>model-生成DTO</strong></h3><p>根据需求分析，DAO接口包括如下：</p>
<ol>
<li>查询待处理视频列表。</li>
<li>保证视频处理结果</li>
<li>添加视频历史处理记录表。</li>
<li>删除已完成视频处理记录</li>
<li>上传处理后的视频文件向media_files插入记录</li>
</ol>
<p>在 mediaProcessMapper中编写根据分片参数获取待处理任务的DAO方法</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> 15182</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 针对表【media_process】的数据库操作Mapper</span></span><br><span class="line"><span class="comment">* <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Entity</span> com.xuecheng.mediaModel.po.MediaProcess</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 根据分片参数获取待处理任务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分片总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardindex 分片序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 任务数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.mediaModel.po.MediaProcess&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 10:58</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT t.* FROM media_process t WHERE t.id % #&#123;shardTotal&#125; = #&#123;shardindex&#125; and t.status=&#x27;1&#x27; limit #&#123;count&#125;&quot;)</span></span><br><span class="line">    List&lt;MediaProcess&gt; <span class="title function_">selectListByShardIndex</span><span class="params">(<span class="meta">@Param(&quot;shardTotal&quot;)</span> <span class="type">int</span> shardTotal, <span class="meta">@Param(&quot;shardindex&quot;)</span> <span class="type">int</span> shardindex, <span class="meta">@Param(&quot;count&quot;)</span> <span class="type">int</span> count)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Service-接口开发"><a href="#Service-接口开发" class="headerlink" title="Service-接口开发"></a><strong>Service-接口开发</strong></h3><h4 id="定义Service方法"><a href="#定义Service方法" class="headerlink" title="定义Service方法"></a>定义Service方法</h4><p>在MediaFileProcessService中定义方法：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.IService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> 15182</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 针对表【media_process】的数据库操作Service</span></span><br><span class="line"><span class="comment">* <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MediaProcessService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;MediaProcess&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status 处理结果，2：成功 / 3：失败</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileId 文件Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 文件访问url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> errorMsg 失败信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/3 11:01</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(<span class="type">int</span> status, String fileId, String url, String errorMsg)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 获取待处理信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardIndex 分配序号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> shardTotal 分配总数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 获取记录数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> java.util.List&lt;com.xuecheng.mediaModel.po.MediaProcess&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/4 14:07</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="实现service方法impl-3"><a href="#实现service方法impl-3" class="headerlink" title="实现service方法impl"></a>实现service方法impl</h4><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaFiles;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcessHistory;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaFilesMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaProcessHistoryMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.mapper.MediaProcessMapper;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaProcessService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> 15182</span></span><br><span class="line"><span class="comment">* <span class="doctag">@description</span> 针对表【media_process】的数据库操作Service实现</span></span><br><span class="line"><span class="comment">* <span class="doctag">@createDate</span> 2023-01-29 17:12:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MediaProcessServiceImpl</span> <span class="keyword">extends</span> <span class="title class_">ServiceImpl</span>&lt;MediaProcessMapper, MediaProcess&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">MediaProcessService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaFilesMapper mediaFilesMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessMapper mediaProcessMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MediaProcessHistoryMapper mediaProcessHistoryMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveProcessFinishStatus</span><span class="params">(<span class="type">int</span> status, String fileId, String url, String errorMsg)</span> &#123;</span><br><span class="line">        LambdaQueryWrapper&lt;MediaProcess&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(MediaProcess::getFileId, fileId);</span><br><span class="line">        <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> mediaProcessMapper.selectOne(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span> (mediaProcess == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//处理失败结果</span></span><br><span class="line">        <span class="keyword">if</span> (status == <span class="number">3</span>)&#123;</span><br><span class="line">            mediaProcess.setStatus(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">            mediaProcess.setErrormsg(errorMsg);</span><br><span class="line">            mediaProcessMapper.updateById(mediaProcess);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> mediaFilesMapper.selectById(fileId);</span><br><span class="line">        <span class="keyword">if</span> (mediaFiles != <span class="literal">null</span>)&#123;</span><br><span class="line">            mediaFiles.setUrl(url);</span><br><span class="line">            mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mediaProcess.setUrl(url);</span><br><span class="line">        mediaProcess.setStatus(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        mediaProcess.setFinishDate(LocalDateTime.now());</span><br><span class="line">        mediaProcessMapper.updateById(mediaProcess);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加到历史记录</span></span><br><span class="line">        <span class="type">MediaProcessHistory</span> <span class="variable">mediaProcessHistory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcessHistory</span>();</span><br><span class="line">        BeanUtils.copyProperties(mediaProcess, mediaProcessHistory);</span><br><span class="line">        mediaProcessHistoryMapper.insert(mediaProcessHistory);</span><br><span class="line">        <span class="comment">//删除mediaProcess</span></span><br><span class="line">        mediaProcessMapper.deleteById(mediaProcess.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;MediaProcess&gt; <span class="title function_">getMediaProcessList</span><span class="params">(<span class="type">int</span> shardIndex, <span class="type">int</span> shardTotal, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcessList = mediaProcessMapper.selectListByShardIndex(shardTotal, shardIndex, count);</span><br><span class="line">        <span class="keyword">return</span> mediaProcessList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<hr>
<h3 id="utils-任务类开发"><a href="#utils-任务类开发" class="headerlink" title="utils-任务类开发"></a><strong>utils-任务类开发</strong></h3><h4 id="视频处理工具类"><a href="#视频处理工具类" class="headerlink" title="视频处理工具类"></a><strong>视频处理工具类</strong></h4><p>将课程资料目录中的util.zip解压，将解压出的工具类拷贝至base工程，并在base工程添加如下依赖：</p>
<p><img src="https://s2.loli.net/2023/02/04/WxPokVe1jzS7DFO.png" alt="image-20230204141021004"></p>
<hr>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- fast Json --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- servlet Api 依赖 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 通用组件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<p>其中Mp4VideoUtil类是用于将视频转为mp4格式，是我们项目要使用的工具类。</p>
<p>下边看下这个类的代码，并进行测试。</p>
<p>我们要通过ffmpeg对视频转码，Java程序调用ffmpeg，使用java.lang.ProcessBuilder去完成，具体在Mp4VideoUtil类的63行。</p>
<p>使用该类的main方法进行测试</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">//ffmpeg的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ffmpeg_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\soft\\ffmpeg\\ffmpeg.exe&quot;</span>;<span class="comment">//ffmpeg的安装位置</span></span><br><span class="line">    <span class="comment">//源avi视频的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">video_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.avi&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的名称</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_name</span> <span class="operator">=</span> <span class="string">&quot;nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//转换后mp4文件的路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">mp4_path</span> <span class="operator">=</span> <span class="string">&quot;D:\\develop\\bigfile_test\\nacos01.mp4&quot;</span>;</span><br><span class="line">    <span class="comment">//创建工具类对象</span></span><br><span class="line">    <span class="type">Mp4VideoUtil</span> <span class="variable">videoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpeg_path,video_path,mp4_name,mp4_path);</span><br><span class="line">    <span class="comment">//开始视频转换，成功将返回success</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> videoUtil.generateMp4();</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>执行main方法，最终在控制台输出 success 表示执行成功。</p>
<h4 id="定义任务类"><a href="#定义任务类" class="headerlink" title="定义任务类"></a><strong>定义任务类</strong></h4><p>视频采用并发处理，每个视频使用一个线程去处理，每次处理的视频数量不要超过cpu核心数。</p>
<p>所有视频处理完成结束本次执行，为防止代码异常出现无限期等待添加超时设置，到达超时时间还没有处理完成仍结束任务。</p>
<p>在media-service工程的 jobhandler文件夹中定义任务类VideoTask 如下：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.mediaService.jobhandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xuecheng.base.utils.Mp4VideoUtil;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaModel.po.MediaProcess;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaFilesService;</span><br><span class="line"><span class="keyword">import</span> com.xuecheng.mediaService.service.MediaProcessService;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.context.XxlJobHelper;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.annotation.XxlJob;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.Executors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 视频处理任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/3 11:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MediaFilesService mediaFilesService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MediaProcessService mediaProcessService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ffmpeg绝对路径</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;videoprocess.ffmpegpath&#125;&quot;)</span></span><br><span class="line">    String ffmpegPath;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//视频处理</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;videoJobHandler&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoJobHandler</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 分片参数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">shardIndex</span> <span class="operator">=</span> XxlJobHelper.getShardIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">shardTotal</span> <span class="operator">=</span> XxlJobHelper.getShardTotal();</span><br><span class="line">        log.debug(<span class="string">&quot;shardIndex=&quot;</span> + shardIndex + <span class="string">&quot;,shardTotal=&quot;</span> + shardTotal);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//一次取出2条记录，可以调整此数据，一次处理的最大个数不要超过cpu核心数</span></span><br><span class="line">        List&lt;MediaProcess&gt; mediaProcesses = mediaProcessService.getMediaProcessList(shardIndex, shardTotal, <span class="number">2</span>);</span><br><span class="line">        <span class="comment">//数据个数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> mediaProcesses.size();</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;取出待处理视频记录&quot;</span> + size + <span class="string">&quot;条&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动size上线程数量的线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(size);</span><br><span class="line">        <span class="comment">//计数器</span></span><br><span class="line">        <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line"></span><br><span class="line">        mediaProcesses.forEach(mediaProcess -&gt; &#123;</span><br><span class="line">            threadPool.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//桶</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">bucket</span> <span class="operator">=</span> mediaProcess.getBucket();</span><br><span class="line">                <span class="comment">//存储路径</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> mediaProcess.getFilePath();</span><br><span class="line">                <span class="comment">//原始视频的md5值</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> mediaProcess.getFileId();</span><br><span class="line">                <span class="comment">//原始文件名称</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> mediaProcess.getFilename();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//下载文件</span></span><br><span class="line">                <span class="comment">//先创建临时文件，为原始的视频文件</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">originalVideo</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">//处理结束的mp4文件</span></span><br><span class="line">                <span class="type">File</span> <span class="variable">mp4Video</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    originalVideo = File.createTempFile(<span class="string">&quot;original&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">                    mp4Video = File.createTempFile(<span class="string">&quot;mp4&quot;</span>, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;下载待处理的原始文件前创建临时文件失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    originalVideo = mediaFilesService.downloadFileFromMinIO(originalVideo, bucket, filePath);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//开始处理视频</span></span><br><span class="line">                    <span class="type">Mp4VideoUtil</span> <span class="variable">mp4VideoUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mp4VideoUtil</span>(ffmpegPath, originalVideo.getAbsolutePath(), mp4Video.getName(), mp4Video.getAbsolutePath());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> mp4VideoUtil.generateMp4();</span><br><span class="line">                    <span class="keyword">if</span> (!result.equals(<span class="string">&quot;success&quot;</span>)) &#123;</span><br><span class="line">                        <span class="comment">//记录错误信息</span></span><br><span class="line">                        log.error(<span class="string">&quot;generateMp4 error ,video_path is &#123;&#125;,error msg is &#123;&#125;&quot;</span>, bucket + filePath, result);</span><br><span class="line">                        mediaProcessService.saveProcessFinishStatus(<span class="number">3</span>, fileId, <span class="literal">null</span>, result);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//将mp4上传至minio</span></span><br><span class="line">                    <span class="comment">//文件路径</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> getFilePath(fileId, <span class="string">&quot;.mp4&quot;</span>);</span><br><span class="line">                    mediaFilesService.addMediaFilesToMinIO(mp4Video.getAbsolutePath(), bucket, objectName);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//访问url</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;/&quot;</span> + bucket + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">                    <span class="comment">//将url存储至数据，并更新状态为成功，并将待处理视频记录删除存入历史</span></span><br><span class="line">                    mediaProcessService.saveProcessFinishStatus(<span class="number">2</span>, fileId, url, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//清理文件</span></span><br><span class="line">                    <span class="keyword">if</span> (originalVideo != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            originalVideo.delete();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (mp4Video != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mp4Video.delete();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line"></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//等待,给一个充裕的超时时间,防止无限等待，到达超时时间还没有处理完成则结束任务</span></span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getFilePath</span><span class="params">(String fileMd5,String fileExt)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>   fileMd5.substring(<span class="number">0</span>,<span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + fileMd5.substring(<span class="number">1</span>,<span class="number">2</span>) + <span class="string">&quot;/&quot;</span> + fileMd5 + <span class="string">&quot;/&quot;</span> +fileMd5 +fileExt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="视频处理测试"><a href="#视频处理测试" class="headerlink" title="视频处理测试"></a><strong>视频处理测试</strong></h3><h4 id="上传视频代码完善"><a href="#上传视频代码完善" class="headerlink" title="上传视频代码完善"></a><strong>上传视频代码完善</strong></h4><p>上传视频成功根据视频文件格式判断，如果是avi文件则需要加入视频待处理表。</p>
<blockquote>
<p>前面mediaserviceImpl的代码已经修改完毕</p>
</blockquote>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> companyId           机构id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileMd5             文件md5值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uploadFileParamsDto 上传文件的信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bucket_files        桶</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> objectName          对象名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> com.xuecheng.mediaModel.po.MediaFiles</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@description</span> 将文件信息添加到数据库</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@date</span> 2023/2/1 20:57</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> MediaFiles <span class="title function_">addMediaFilesToDB</span><span class="params">(Long companyId, String fileMd5, UploadFileParamsDto uploadFileParamsDto, String bucket_files, String objectName)</span> &#123;</span><br><span class="line">        <span class="comment">//保存到数据库</span></span><br><span class="line">        <span class="type">MediaFiles</span> <span class="variable">mediaFiles</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaFiles</span>();</span><br><span class="line">        <span class="comment">//封装数据</span></span><br><span class="line">        BeanUtils.copyProperties(uploadFileParamsDto, mediaFiles);</span><br><span class="line">        mediaFiles.setId(fileMd5);</span><br><span class="line">        mediaFiles.setFileId(fileMd5);</span><br><span class="line">        mediaFiles.setCompanyId(companyId);</span><br><span class="line">        mediaFiles.setBucket(bucket_files);</span><br><span class="line">        mediaFiles.setFilePath(objectName);</span><br><span class="line">        mediaFiles.setUrl(<span class="string">&quot;/&quot;</span> + bucket_files + <span class="string">&quot;/&quot;</span> + objectName);</span><br><span class="line">        mediaFiles.setCreateDate(LocalDateTime.now());</span><br><span class="line">        mediaFiles.setStatus(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        mediaFiles.setAuditStatus(<span class="string">&quot;002004&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入文件表</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> mediaFilesMapper.insert(mediaFiles);</span><br><span class="line">        <span class="keyword">if</span> (insert &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            XueChengException.cast(<span class="string">&quot;保存文件信息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取出文件扩展名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">extension</span> <span class="operator">=</span> objectName.substring(objectName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//如果是avi则加入视频处理表</span></span><br><span class="line">        <span class="keyword">if</span> (extension.equalsIgnoreCase(<span class="string">&quot;.avi&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">MediaProcess</span> <span class="variable">mediaProcess</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaProcess</span>();</span><br><span class="line">            BeanUtils.copyProperties(mediaFiles, mediaProcess);</span><br><span class="line">            mediaProcessMapper.insert(mediaProcess);</span><br><span class="line">            <span class="comment">//更新url为空</span></span><br><span class="line">            mediaFiles.setUrl(<span class="literal">null</span>);</span><br><span class="line">            mediaFilesMapper.updateById(mediaFiles);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mediaFiles;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="视频处理调度策略"><a href="#视频处理调度策略" class="headerlink" title="视频处理调度策略"></a><strong>视频处理调度策略</strong></h4><p>进入xxl-job调度中心添加执行器和任务，在xxl-job配置任务调度策略：</p>
<ol>
<li><p>配置阻塞处理策略为：丢弃后续调度。</p>
</li>
<li><p>配置视频处理调度时间间隔不用根据视频处理时间去确定，可以配置的小一些，如：5分钟，即使到达调度时间如果视频没有处理完会丢失调度请求。</p>
</li>
</ol>
<img src="https://s2.loli.net/2023/02/04/VCJEfyiZIp36dHz.png" alt="image-20230204141648093" style="zoom:67%;" />

<p>配置完成开始测试视频处理：</p>
<ol>
<li><p>首先上传至少4个视频，非mp4格式。</p>
</li>
<li><p>启动媒资管理服务，观察日志</p>
</li>
</ol>
<blockquote>
<p>注意：如果数据库在导表的时候添加了 processHistory 数据，要记得删除，确保 process 表和 processhistory 表都是空的，否则在视频转码完成写入进历史表时会冲突</p>
</blockquote>
<h2 id="绑定媒资"><a href="#绑定媒资" class="headerlink" title="绑定媒资"></a><strong>绑定媒资</strong></h2><h3 id="需求分析-4"><a href="#需求分析-4" class="headerlink" title="需求分析"></a><strong>需求分析</strong></h3><h4 id="业务流程-2"><a href="#业务流程-2" class="headerlink" title="业务流程"></a><strong>业务流程</strong></h4><p>到目前为止，媒资管理已完成文件上传、视频处理、我的媒资功能等基本功能，其它模块可以使用媒资文件，本节要讲解课程计划绑定媒资文件。</p>
<ol>
<li>首先进入课程计划界面，然后选择要绑定的视频进行绑定即可。</li>
</ol>
<p>具体的业务流程如下：</p>
<ol>
<li><p>教育机构用户进入课程管理页面并编辑某一个课程，在&quot;课程大纲&quot;标签页的某一小节后可点击”添加视频”。</p>
</li>
<li><p>弹出添加视频对话框，可通过视频关键字搜索已审核通过的视频媒资。</p>
</li>
<li><p>选择视频媒资，点击提交按钮，完成课程计划绑定媒资流程。</p>
</li>
</ol>
<p><strong>8.1.2 数据模型</strong></p>
<p>课程计划绑定媒资文件后存储至课程计划teachplan绑定媒资表media</p>
<h4 id="接口定义-2"><a href="#接口定义-2" class="headerlink" title="接口定义"></a><strong>接口定义</strong></h4><p>根据业务流程，用户进入课程计划列表，首先确定向哪个课程计划添加视频，点击”添加视频”后用户选择视频，选择视频，点击提交，提交媒资文件id、文件名称、教学计划id，示例如下：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JSON</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mediaId&quot;</span>: <span class="string">&quot;70a98b4a2fffc89e50b101f959cc33ca&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;22-Hmily实现TCC事务-开发bank2的confirm方法.avi&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachplanId&quot;</span>: <span class="number">257</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>此接口在内容管理模块content提供</p>
<h3 id="model-生成DTO-4"><a href="#model-生成DTO-4" class="headerlink" title="model-生成DTO"></a>model-生成DTO</h3><p>在内容管理模块content定义请求参数模型类型：</p>
<blockquote>
<p>注意：对象类型要和数据库的对应</p>
</blockquote>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuecheng.contentModel.dto;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiModelProperty;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xioaming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 教学计划-媒资绑定提交数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/3 16:14</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BindTeachplanMediaDto</span> &#123;</span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;媒资文件id&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String mediaId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;媒资文件名称&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程计划标识&quot;, required = true)</span></span><br><span class="line">    <span class="keyword">private</span> Long teachplanId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="service-接口开发-3"><a href="#service-接口开发-3" class="headerlink" title="service-接口开发"></a><strong>service-接口开发</strong></h3><h4 id="定义service方法-3"><a href="#定义service方法-3" class="headerlink" title="定义service方法"></a>定义service方法</h4><p>根据需求在teachplanservice中定义接口</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 教学计划板顶媒资</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bindTeachplanMediaDto 教学计划-媒资绑定提交数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> com.xuecheng.contentModel.po.TeachplanMedia</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/3 16:18</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 删除教学计划与媒资之间的绑定关系</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> teachPlanId 教学计划Id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mediaId 媒资文件Id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiaoming</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2023/2/3 16:20</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAssociationMedia</span><span class="params">(Long teachPlanId, String mediaId)</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="实现service方法impl-4"><a href="#实现service方法impl-4" class="headerlink" title="实现service方法impl"></a>实现service方法impl</h4><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> TeachplanMedia <span class="title function_">associationMedia</span><span class="params">(BindTeachplanMediaDto bindTeachplanMediaDto)</span> &#123;</span><br><span class="line">    <span class="comment">//教学计划id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">teachplanId</span> <span class="operator">=</span> bindTeachplanMediaDto.getTeachplanId();</span><br><span class="line">    <span class="type">Teachplan</span> <span class="variable">teachplan</span> <span class="operator">=</span> teachplanMapper.selectById(teachplanId);</span><br><span class="line">    <span class="keyword">if</span> (teachplan == <span class="literal">null</span>) &#123;</span><br><span class="line">        XueChengException.cast(<span class="string">&quot;教学计划不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">grade</span> <span class="operator">=</span> teachplan.getGrade();</span><br><span class="line">    <span class="keyword">if</span> (grade != <span class="number">2</span>) &#123;</span><br><span class="line">        XueChengException.cast(<span class="string">&quot;只允许第二级教学计划绑定媒资文件&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//课程id</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">courseId</span> <span class="operator">=</span> teachplan.getCourseId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先删除原因该教学计划绑定的媒资</span></span><br><span class="line">    teachplanMediaMapper.delete(<span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;TeachplanMedia&gt;().eq(TeachplanMedia::getTeachplanId, teachplanId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//再添加教学计划与媒资的绑定关系</span></span><br><span class="line">    <span class="type">TeachplanMedia</span> <span class="variable">teachplanMedia</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TeachplanMedia</span>();</span><br><span class="line">    teachplanMedia.setCourseId(courseId);</span><br><span class="line">    teachplanMedia.setTeachplanId(teachplanId);</span><br><span class="line">    teachplanMedia.setMediaFilename(bindTeachplanMediaDto.getFileName());</span><br><span class="line">    teachplanMedia.setMediaId(bindTeachplanMediaDto.getMediaId());</span><br><span class="line">    teachplanMedia.setCreateDate(LocalDateTime.now());</span><br><span class="line">    teachplanMediaMapper.insert(teachplanMedia);</span><br><span class="line">    <span class="keyword">return</span> teachplanMedia;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAssociationMedia</span><span class="params">(Long teachPlanId, String mediaId)</span> &#123;</span><br><span class="line">    LambdaQueryWrapper&lt;TeachplanMedia&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">LambdaQueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(TeachplanMedia::getTeachplanId, teachPlanId);</span><br><span class="line">    queryWrapper.eq(TeachplanMedia::getMediaId, mediaId);</span><br><span class="line">    teachplanMediaMapper.delete(queryWrapper);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="api-定义接口"><a href="#api-定义接口" class="headerlink" title="api-定义接口"></a>api-定义接口</h3><p>在teachplancontroller中添加接口：</p>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/teachplan/association/media&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">associationMedia</span><span class="params">(<span class="meta">@RequestBody</span> BindTeachplanMediaDto bindTeachplanMediaDto)</span>&#123;</span><br><span class="line">    teachplanService.associationMedia(bindTeachplanMediaDto);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteAssociationMedia</span><span class="params">(<span class="meta">@PathVariable</span> Long teachPlanId, <span class="meta">@PathVariable</span> String mediaId)</span>&#123;</span><br><span class="line">    teachplanService.deleteAssociationMedia(teachPlanId, mediaId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="接口测试-4"><a href="#接口测试-4" class="headerlink" title="接口测试"></a><strong>接口测试</strong></h3><ol>
<li>使用httpclient测试</li>
</ol>
<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Plain Text</span><br><span class="line">### 课程计划绑定视频</span><br><span class="line">POST &#123;&#123;media_host&#125;&#125;/media/teachplan/association/media</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;mediaId&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fileName&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;teachplanId&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">### 课程计划接触视频绑定</span><br><span class="line">DELETE &#123;&#123;media_host&#125;&#125;/media/teachplan/association/media/&#123;teachPlanId&#125;/&#123;mediaId&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>前后端联调</li>
</ol>
<p>此功能较为简单推荐直接前后端联调：重启content-api工程，向指定课程计划添加视频、解除视频绑定。</p>
<h1 id="OVER"><a href="#OVER" class="headerlink" title="OVER~~"></a>OVER~~</h1></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://haoming1130.github.io">Haoming Lu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://haoming1130.github.io/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/">http://haoming1130.github.io/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://haoming1130.github.io" target="_blank">小明学习博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/02/04/%E7%AE%97%E6%B3%95%E8%AE%AD%E7%BB%83%E8%90%A5--day56/"><img class="prev-cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">算法训练营（day56）</div></div></a></div><div class="next-post pull-right"><a href="/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%89%E6%9C%9F/"><img class="next-cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">学成在线项目笔记第三期</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2022/12/04/%E7%AC%94%E8%AE%B0--%E5%A4%96%E5%8D%96%E5%B9%B3%E5%8F%B0%E5%8F%8A%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88%E4%BC%98%E5%8C%96%E7%AF%87%EF%BC%89/" title="点餐外卖系统项目（优化篇）"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">点餐外卖系统项目（优化篇）</div></div></a></div><div><a href="/2022/12/04/%E7%AC%94%E8%AE%B0--%E5%A4%96%E5%8D%96%E5%B9%B3%E5%8F%B0%E5%8F%8A%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88%E5%90%8E%E5%8F%B0%EF%BC%89/" title="点餐外卖系统项目（管理端）"><img class="cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">点餐外卖系统项目（管理端）</div></div></a></div><div><a href="/2022/12/04/%E7%AC%94%E8%AE%B0--%E5%A4%96%E5%8D%96%E5%B9%B3%E5%8F%B0%E5%8F%8A%E7%A7%BB%E5%8A%A8%E7%AB%AF%E5%BC%80%E5%8F%91%EF%BC%88%E7%A7%BB%E5%8A%A8%E7%AB%AF%EF%BC%89/" title="点餐外卖系统项目（移动端）"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-04</div><div class="title">点餐外卖系统项目（移动端）</div></div></a></div><div><a href="/2022/12/28/%E4%BC%99%E4%BC%B4%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F(Vant4)%E8%B8%A9%E5%9D%91/" title="伙伴匹配系统踩坑"><img class="cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-12-28</div><div class="title">伙伴匹配系统踩坑</div></div></a></div><div><a href="/2023/01/19/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%B8%80%E6%9C%9F/" title="学成在线项目笔记第一期"><img class="cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-19</div><div class="title">学成在线项目笔记第一期</div></div></a></div><div><a href="/2023/01/24/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E4%BA%8C%E6%9C%9F/" title="学成在线项目笔记第二期"><img class="cover" src="https://s2.loli.net/2022/12/04/IWqKCzP5gwNfbVL.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-01-24</div><div class="title">学成在线项目笔记第二期</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Haoming Lu</div><div class="author-info__description">一个经常写bug的乖小孩</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">73</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="mailto:1518244487@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AA%92%E8%B5%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-number">1.</span> <span class="toc-text">媒资管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">模块需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.1.</span> <span class="toc-text">模块介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E6%A8%A1%E5%9D%97%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">搭建模块环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.</span> <span class="toc-text">架构的问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BANacos"><span class="toc-number">1.2.2.</span> <span class="toc-text">搭建Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%AD%E5%BF%83"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">服务发现中心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%AC%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">公用配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">配置优先级</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAGateway"><span class="toc-number">1.2.3.</span> <span class="toc-text">搭建Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEbootstrap-yaml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">配置bootstrap.yaml配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">接口测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">更改前端工程接口</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E5%AA%92%E8%B5%84%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.2.4.</span> <span class="toc-text">搭建媒资工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.3.</span> <span class="toc-text">分布式文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MinIO%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.1.</span> <span class="toc-text">MinIO介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MinIO%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.2.</span> <span class="toc-text">MinIO安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6-%E5%9B%BE%E7%89%87-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.3.</span> <span class="toc-text">上传文件(图片)测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MinIO%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.4.</span> <span class="toc-text">MinIO参数说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MinIO%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.5.</span> <span class="toc-text">MinIO功能测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-number">1.4.</span> <span class="toc-text">上传图片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.4.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">业务流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">数据模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">接口定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-number">1.4.2.</span> <span class="toc-text">准备环境</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEbucket"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">配置bucket</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E5%86%99minio%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">编写minio配置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#model-%E7%94%9F%E6%88%90DTO"><span class="toc-number">1.4.3.</span> <span class="toc-text">model-生成DTO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%AA%92%E8%B5%84%E6%96%87%E4%BB%B6%E6%9F%A5%E8%AF%A2%E8%AF%B7%E6%B1%82%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">定义媒资文件查询请求模型类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E5%93%8D%E5%BA%94%E6%A8%A1%E5%9E%8B%E7%B1%BB"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">定义上传响应模型类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E7%B1%BB"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">定义请求参数类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.4.4.</span> <span class="toc-text">service-接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89service%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">定义service方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0service%E6%96%B9%E6%B3%95impl"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">实现service方法impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89"><span class="toc-number">1.4.5.</span> <span class="toc-text">api-接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-1"><span class="toc-number">1.4.6.</span> <span class="toc-text">接口测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#httpClient%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">httpClient测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E8%81%94%E8%B0%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.6.2.</span> <span class="toc-text">前后端联调测试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bug%E4%BF%AE%E5%A4%8D"><span class="toc-number">1.4.7.</span> <span class="toc-text">bug修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91"><span class="toc-number">1.5.</span> <span class="toc-text">上传视频</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.2.</span> <span class="toc-text">断点续传流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">什么是断点续传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%9D%97%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">分块原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E5%8E%9F%E7%90%86"><span class="toc-number">1.5.2.3.</span> <span class="toc-text">合并原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.2.4.</span> <span class="toc-text">上传视频流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83-1"><span class="toc-number">1.5.3.</span> <span class="toc-text">准备环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#model-%E7%94%9F%E6%88%90DTO-1"><span class="toc-number">1.5.4.</span> <span class="toc-text">model-生成DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-1"><span class="toc-number">1.5.5.</span> <span class="toc-text">service-接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89service%E6%96%B9%E6%B3%95-1"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">定义service方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0service%E6%96%B9%E6%B3%95impl-1"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">实现service方法impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api-%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.5.6.</span> <span class="toc-text">api-接口定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-2"><span class="toc-number">1.5.7.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88"><span class="toc-number">1.6.</span> <span class="toc-text">文件预览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-2"><span class="toc-number">1.6.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-1"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">接口定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#model-%E7%94%9F%E6%88%90DTO-2"><span class="toc-number">1.6.2.</span> <span class="toc-text">model-生成DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-2"><span class="toc-number">1.6.3.</span> <span class="toc-text">service-接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89service%E6%96%B9%E6%B3%95-2"><span class="toc-number">1.6.3.1.</span> <span class="toc-text">定义service方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0service%E6%96%B9%E6%B3%95impl-2"><span class="toc-number">1.6.3.2.</span> <span class="toc-text">实现service方法impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-3"><span class="toc-number">1.6.4.</span> <span class="toc-text">接口测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86"><span class="toc-number">1.7.</span> <span class="toc-text">视频处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#FFmpeg-%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">FFmpeg 的基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E5%A4%84%E7%90%86%E6%A6%82%E5%BF%B5"><span class="toc-number">1.7.2.</span> <span class="toc-text">分布式任务处理概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">什么是分布式任务调度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XXL-JOB%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.7.3.</span> <span class="toc-text">XXL-JOB介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAXXL-JOB"><span class="toc-number">1.7.4.</span> <span class="toc-text">搭建XXL-JOB</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDXXL-JOB"><span class="toc-number">1.7.4.1.</span> <span class="toc-text">下载XXL-JOB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.7.4.2.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.7.4.3.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%B7%A5%E7%A8%8B"><span class="toc-number">1.7.4.4.</span> <span class="toc-text">启动工程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">1.7.5.</span> <span class="toc-text">配置执行器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96-1"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnacos%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">配置nacos信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AExxl-job%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">配置xxl-job执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%89%A7%E8%A1%8C%E5%99%A8"><span class="toc-number">1.7.5.4.</span> <span class="toc-text">添加执行器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.7.5.5.</span> <span class="toc-text">测试连接</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-3"><span class="toc-number">1.7.6.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E5%88%86%E7%89%87%E6%96%B9%E6%A1%88"><span class="toc-number">1.7.6.1.</span> <span class="toc-text">作业分片方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E8%AF%81%E4%BB%BB%E5%8A%A1%E4%B8%8D%E9%87%8D%E5%A4%8D%E6%89%A7%E8%A1%8C"><span class="toc-number">1.7.6.2.</span> <span class="toc-text">保证任务不重复执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-1"><span class="toc-number">1.7.6.3.</span> <span class="toc-text">业务流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#model-%E7%94%9F%E6%88%90DTO-3"><span class="toc-number">1.7.7.</span> <span class="toc-text">model-生成DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.8.</span> <span class="toc-text">Service-接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89Service%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.8.1.</span> <span class="toc-text">定义Service方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0service%E6%96%B9%E6%B3%95impl-3"><span class="toc-number">1.7.8.2.</span> <span class="toc-text">实现service方法impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#utils-%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%BC%80%E5%8F%91"><span class="toc-number">1.7.9.</span> <span class="toc-text">utils-任务类开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">1.7.9.1.</span> <span class="toc-text">视频处理工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BB%BB%E5%8A%A1%E7%B1%BB"><span class="toc-number">1.7.9.2.</span> <span class="toc-text">定义任务类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%B5%8B%E8%AF%95"><span class="toc-number">1.7.10.</span> <span class="toc-text">视频处理测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0%E8%A7%86%E9%A2%91%E4%BB%A3%E7%A0%81%E5%AE%8C%E5%96%84"><span class="toc-number">1.7.10.1.</span> <span class="toc-text">上传视频代码完善</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E8%B0%83%E5%BA%A6%E7%AD%96%E7%95%A5"><span class="toc-number">1.7.10.2.</span> <span class="toc-text">视频处理调度策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E5%AA%92%E8%B5%84"><span class="toc-number">1.8.</span> <span class="toc-text">绑定媒资</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-4"><span class="toc-number">1.8.1.</span> <span class="toc-text">需求分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B-2"><span class="toc-number">1.8.1.1.</span> <span class="toc-text">业务流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89-2"><span class="toc-number">1.8.1.2.</span> <span class="toc-text">接口定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#model-%E7%94%9F%E6%88%90DTO-4"><span class="toc-number">1.8.2.</span> <span class="toc-text">model-生成DTO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service-%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91-3"><span class="toc-number">1.8.3.</span> <span class="toc-text">service-接口开发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89service%E6%96%B9%E6%B3%95-3"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">定义service方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0service%E6%96%B9%E6%B3%95impl-4"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">实现service方法impl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#api-%E5%AE%9A%E4%B9%89%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.8.4.</span> <span class="toc-text">api-定义接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95-4"><span class="toc-number">1.8.5.</span> <span class="toc-text">接口测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OVER"><span class="toc-number">2.</span> <span class="toc-text">OVER~~</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/23/Java%E9%9D%A2%E7%BB%8F/" title="无题">无题</a><time datetime="2023-02-23T08:40:48.288Z" title="发表于 2023-02-23 16:40:48">2023-02-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/17/ACM%E7%AE%97%E6%B3%95%E9%A2%98/" title="ACM算法题">ACM算法题</a><time datetime="2023-02-17T03:50:46.098Z" title="发表于 2023-02-17 11:50:46">2023-02-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/15/Java%E6%8B%9B%E8%81%98%E8%A6%81%E6%B1%82/" title="面试宝典">面试宝典</a><time datetime="2023-02-15T04:13:58.822Z" title="发表于 2023-02-15 12:13:58">2023-02-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/11/%E7%AE%97%E6%B3%95%E8%AE%AD%E7%BB%83%E8%90%A5--day59/" title="算法训练营（day59）">算法训练营（day59）</a><time datetime="2023-02-11T04:44:08.129Z" title="发表于 2023-02-11 12:44:08">2023-02-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/02/06/Java%E9%9D%A2%E8%AF%95%E9%AB%98%E9%A2%91%E9%A2%98/" title="Java面试高频题">Java面试高频题</a><time datetime="2023-02-06T15:26:28.032Z" title="发表于 2023-02-06 23:26:28">2023-02-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://haoming1130.github.io/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/'
    this.page.identifier = '/2023/02/03/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0%E7%AC%AC%E5%9B%9B%E6%9C%9F/'
    this.page.title = '学成在线项目笔记第四期'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }

  document.getElementById('darkmode').addEventListener('click', () => {
    setTimeout(() => window.disqusReset(), 200)
  })
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><div class="aplayer no-destroy" data-id="1708664797" data-server="tencent" data-type="playlist" data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" data-listFolded="true" data-narrow="false"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" style="margin-inline:5px" data-title="本站已在广东省进行备案" title=""><img src="https://img.shields.io/badge/粤ICP备2023004159号--1-e1d492?style=flat&amp;logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAYAAAC9pNwMAAABS2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDIgNzkuMTYwOTI0LCAyMDE3LzA3LzEzLTAxOjA2OjM5ICAgICAgICAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+nhxg7wAACNlJREFUSInF1mmMVeUdx/Hv2e+5+519mJWBYQZkGxZZxLKJqBXGoLS1iXWrmihotFXaJiTWWlsbl6q1aetWd5u0VkKjNG4YEJSlOCibDLMwM8x679z9nnPP1jcVJUxf+7z6J8+LT37/Z4VvaQhfFS8+sBXbctCDGrVTKlBUH4mxAbI9Hfj0IJLsp6paJ5/tmn20N/D0wKDRMq9F/c3M2U1/V0vDfWMFh+tv/Ig1zYPMabDImPJ52OaXO87W580KggCiiOsJOJ6I3wcNFaaeNKxrt72f2fLGu4FpJ/sDQABRzD22fH7/Yze069vGc6mrDLNIJCDik10sxz2by3VdPM87xzkP9jwPTZFRVI1YUJKH+oy7n3tbvv/P2wW/UQxRWe6w4ZJRptYLHDoCuz8v5cP92XbI762O+h6UVWHnUFbPpU0fEb2A60mMJ7MUi9b/b7UgKhiZMaIxm8YLplLMDPz8hl/EH+rs8TNlUpFf32uyZJGLPDwCiTGUyTWodTN49eUCdz2YwXb9NNcObp1X98WDoufynzMVCEKGn27ayPTWBi5ad8P5iQUkJEnFLjqM9Z+hrVX0vfDe6K2dPRWsW2bwyp9EUifSJB84gdxrkR0eRgv1o/3I4fbbprJ6scqamzVO9pffec1S5ZWY2Nfz5qEy/FqOC2Y3s3j53HMSi18VRjFPwSwg+1RfVbl115vvJrsfej7UGIsYPPGgQ7JXoO+Xx5B3dHEomyJ9x1qiQozkr95h5937aFnVyouPlgJK+Ss7Fxz64OTSxSX+LHYxT2IsRW5kbGI4oHcR0jqoqTjV9se3I7/f8rS/ClS23GxSXhph6L5d9Akm7qqZhHWBQGUJ+CWGFzcg7e7m6D3/ZuW1Ea5YKdA3EojuONi813TqNi+YPYOKUhXDtCeGL26/hakLLiEcdsaHRkRAoLRc4fJrmhnekyF0apgZowWSwwkaa+rw3f8WA1GZZsPP5JEChX8dhZTN6iU6kAcs5s+dHd183SJ0VVKL57pfw6YdRQw23aeWTns47DPTALWlRTR7kMLew6hGgYqUhWXYFFUdPZ6lUBahLA8hVcOftckfi7No7VRAAQqsX1dybfvG1qwriM9mM5mJ4e4jO5Cc01dPqixbr8tWGBQUL4vjGigEEShi+xUmZ2RiR/sJ1pbS8NkgZrKAGw0TsgQsQyFaF/nfYTGprAlMFysbA1pI3mhkR6snhGsaymYGvPyFEb9IdbUE2AzFFTwpRqCtBY0wmdER+hZW4j63gcJj38V+/ErSUZXsYBfjIZHIRW0c2Z8BskCAqN+CbBJBFnyyKjR+Ez57nBxLqpfMUeSISElMBFz6x2Q6OxzWrYjyxWVzEewioU3LCS5vQY6nMUrLwNaxXvoQ59IloFSx54PPAZtQLExVZZDxsVE8J4dn6v4JYatgbSjk0owPw7RGH2ADMo88Z7L20ip8f7gC7fAo0q4+0rt7kEQDvaghVZbiPHUHcyeXcfLjT3jmpR7AYsnSScya3UR8bARVMck7Y/cB75/X6rDf3Fg2dw2jKZm5dXGm1LuAzO5DCo9v6aT0ibco5kzOvLOP+NGTFJtDpPYeZKijk/Rn3QxsfZV7txwhX7ABiZUXBsGvIvguQApNQQva9RMmTvZ2dpVUls+tX/UD7GN/Y8Ws05w6rQF+9vyzg1vZjbvMRJhXiRSU8DpTFFe0QE8S6SfPkOkZoktrB2oAhZWrwljxOPmchiSMYOWNoxNuruFU5vWeXdsojiUon345113dBBQBmTYlTimgdB8nfPo4WjaNFgN9OMEkJ02dnadVt5ki54Esqy+bzKJltVhSPbI3iN2zCyMTeXNCuG7Omm2Zok7PR2+R7jvD8ouruHhmCrB5jVZeYxLdrTP4sr4Vtd9g4MA4qc4c+6cu5NPamfw4P59t2WrA4YdXKkASf7SFivo6PDdEPmf1fRM++zp1bH/0r4I1dD1ODtOWaW4IsvPjL7nqXhloQiSPwjjgMYkMASyGEBkjhISCQwkwzve/18AbT+pk8pVY4UacQi9y+gyZ0eRAw4qHa89LXEx1LXMSPfhDJYRb59BtlLKg2WPT2l6qYl1svtGkrLYckyA1S+t5+2ATm37WCui0LSynsckDNH5zTxAchbQtkx08hDHYiW6NgC0enHBzEZ102UDH8QORdEckjEzZrNWkRydzyx17uGnDXqbUnGZ6dRPjSY91q2TqwjFuvTxLo5Zn5Qo/pumRSFcTLQtybEhGE0fQrDhhJ0VvH2lTnnHPhGtsmWan469apERjI2MH3qN7+7MEfH6ql29CbV7PvsMG32k6yU2XDhEKyZw66eJaRdrXR7CzCcqUNC3zwgymPJRCH4KRRLINimpL14A5Y4GDeOqbsPRVcfuN7Xj44pav/hFfrNT2kr2rsqf2Ibp5pEA14ZIImUyW3t5REkkTXRGQ/DGGhtLginhqCWknQDE5hKf5UFSF9Lj020Q2ul5V1AR2hr+8vuP8Vlc2zMPRxoSjnx7XBC14sDoydahSGq7KdO/HFyrBchxCVfX4fDKp4T7SCQejYODZLrYgIqgKFsNIgQqEYob8mW6yiUyb7Z64LVK/+B85xznnJ3AWzqTzuIX46mr5wLs+UUTyIriBCjRNxguHMJIFDLEEvXEOVRWnSJ0+jCd4CJoGjoedM1CLcXQziW3nMV2TSMBeOx7vWZvPt1r+cMPzE8KunaUkFn0vNrvtqXj34c1W6gzxlEQ6naIoBahtnkMwoFMwIVzSRNguMt53Aj2s4nkSlgPoGqLkICsRNF0gl8rYWuP8+11/w/OOJDEhHPKLCIpOXmi+M9AgP+maiesLifF2T1Rn5ZNj5Lo/Qc/GcPMmhdoqlEgIGzCK4PiCmJKK68p4KfF3qYGuF0qCRUkJTzleUbvQyWRTuE5xYthxQbBs7EISAbkzUFG3VfXXbK2YFi3X/eryfKKnqVBItNjJxDzH8erddC4SqWwcN5WyTtlyO1RP/Lh3eHD76MB40swmiDVJyDLYRhpc5+ub6tse/wWKbvSQEAw1awAAAABJRU5ErkJggg==" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral" style="margin-inline:5px" data-title="本站使用为静态资源提供CDN加速" title=""><img src="https://img.shields.io/badge/CDN-又拍云-orange?style=flat&amp;logo=又拍云" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="https://unpkg.zhimg.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.min.js"></script><!-- hexo injector body_end end --></body></html>